<!DOCTYPE html>
<html lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LADODO - Symbols Edition</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Righteous&display=swap');
        body { 
            background: radial-gradient(circle at center, #1e1b4b 0%, #020617 100%);
            color: white; user-select: none; font-family: 'Righteous', cursive; 
            overflow: hidden; touch-action: manipulation;
        }
        
        .glass { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); }
        
        @keyframes jump-on {
            0% { transform: scale(1) translateY(0); }
            50% { transform: scale(1.3) translateY(-20px); }
            100% { transform: scale(1) translateY(0); }
        }
        .winner-jump { animation: jump-on 0.6s ease-in-out 3; }

        @keyframes die-loss {
            0% { opacity: 1; transform: scale(1); }
            100% { opacity: 0; transform: scale(0) rotate(180deg); }
        }
        .losing-die { animation: die-loss 1s forwards; }

        .active-ring { box-shadow: 0 0 15px #eab308; border: 2px solid #eab308; }
        .dice-shadow { filter: drop-shadow(0 4px 6px rgba(0,0,0,0.5)); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script>
        // --- AUDIO ENGINE ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const playSound = (type) => {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain); gain.connect(audioCtx.destination);
            const now = audioCtx.currentTime;

            if (type === 'click') {
                osc.frequency.setValueAtTime(600, now);
                gain.gain.setValueAtTime(0.1, now);
                osc.stop(now + 0.1);
            } else if (type === 'win') {
                osc.type = 'triangle'; osc.frequency.setValueAtTime(400, now);
                osc.frequency.linearRampToValueAtTime(800, now + 0.3);
                gain.gain.setValueAtTime(0.1, now);
                osc.start(); osc.stop(now + 0.5);
            } else if (type === 'error') {
                osc.type = 'sawtooth'; osc.frequency.setValueAtTime(150, now);
                gain.gain.setValueAtTime(0.1, now);
                osc.start(); osc.stop(now + 0.3);
            }
            if (type !== 'win' && type !== 'error') osc.start();
        };

        // --- FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyCUvDUDrj1MofAFRYeDrGP7OoIz0qX0iW8",
            authDomain: "dudogame-44b81.firebaseapp.com",
            databaseURL: "https://dudogame-44b81-default-rtdb.europe-west1.firebasedatabase.app/",
            projectId: "dudogame-44b81",
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        const { useState, useEffect, useMemo } = React;
        const AVATARS = ['üòé', 'ü§†', 'üëΩ', 'üëª', 'ü§ñ', 'ü¶ä', 'ü¶Å', 'ü¶Ñ', 'üê∏', 'üêµ'];

        const DiceIcon = ({ value, size = 40, color = "#1e293b", dotColor = "white", className = "" }) => {
            const dots = {
                1: [[50, 50]], 2: [[25, 25], [75, 75]], 3: [[25, 25], [50, 50], [75, 75]],
                4: [[25, 25], [25, 75], [75, 25], [75, 75]], 
                5: [[25, 25], [25, 75], [50, 50], [75, 25], [75, 75]],
                6: [[25, 25], [25, 50], [25, 75], [75, 25], [75, 50], [75, 75]]
            };
            return React.createElement('svg', { width: size, height: size, viewBox: '0 0 100 100', className: `dice-shadow ${className}` },
                React.createElement('rect', { x: 5, y: 5, width: 90, height: 90, rx: 15, fill: value === 1 ? '#ef4444' : color, stroke: 'rgba(255,255,255,0.2)', strokeWidth: 2 }),
                dots[value]?.map(([cx, cy], i) => React.createElement('circle', { key: i, cx, cy, r: 8, fill: dotColor }))
            );
        };

        const App = () => {
            const [player, setPlayer] = useState(() => {
                const saved = JSON.parse(sessionStorage.getItem('ladodo_player_v2') || '{}');
                return {
                    id: saved.id || Math.random().toString(36).substring(2, 9),
                    name: saved.name || 'P'+Math.floor(Math.random()*100),
                    avatar: saved.avatar || AVATARS[Math.floor(Math.random() * AVATARS.length)]
                };
            });
            const [gameState, setGameState] = useState(null);
            const [roomId, setRoomId] = useState('');
            const [localBid, setLocalBid] = useState({ quantity: 1, value: 2 });
            const [isEditMode, setIsEditMode] = useState(false);

            useEffect(() => {
                sessionStorage.setItem('ladodo_player_v2', JSON.stringify(player));
                if (roomId && gameState) {
                    db.ref(`rooms/${roomId}/players/${player.id}`).update({ name: player.name, avatar: player.avatar });
                }
            }, [player]);

            useEffect(() => {
                const code = new URLSearchParams(window.location.search).get('room');
                if (code) { setRoomId(code); joinRoom(code); }
            }, []);

            useEffect(() => {
                if (!roomId) return;
                const roomRef = db.ref(`rooms/${roomId}`);
                roomRef.on('value', (snap) => {
                    const val = snap.val();
                    if (val) {
                        if (val.phase === 'REVEALED' && gameState?.phase !== 'REVEALED') {
                            playSound(val.lastAction?.success ? 'win' : 'error');
                            if (val.lastAction?.success) confetti({ particleCount: 100, colors: ['#22c55e'] });
                        }
                        setGameState(val);
                        if (val.currentBid && val.phase === 'PLAYING') setLocalBid(val.currentBid);
                    }
                });
                return () => roomRef.off();
            }, [roomId, gameState?.phase]);

            const createRoom = () => {
                const code = Math.floor(1000 + Math.random() * 9000).toString();
                const initial = {
                    roomId: code, hostId: player.id, phase: 'LOBBY', turnIndex: 0,
                    playerSequence: [player.id], players: { [player.id]: { ...player, diceCount: 5, dice: [] } }
                };
                db.ref(`rooms/${code}`).set(initial);
                setRoomId(code);
            };

            const joinRoom = (code = roomId) => {
                db.ref(`rooms/${code}`).transaction((room) => {
                    if (room) {
                        if (!room.players[player.id]) {
                            room.players[player.id] = { ...player, diceCount: 5, dice: [] };
                            room.playerSequence.push(player.id);
                        }
                    }
                    return room;
                });
                setRoomId(code);
            };

            const roll = (n) => Array.from({ length: n }, () => Math.floor(Math.random() * 6) + 1);

            const startRound = () => {
                const newPlayers = { ...gameState.players };
                gameState.playerSequence.forEach(pid => {
                    if (newPlayers[pid].diceCount > 0) newPlayers[pid].dice = roll(newPlayers[pid].diceCount);
                });
                db.ref(`rooms/${roomId}`).update({
                    phase: 'PLAYING', players: newPlayers, currentBid: null, lastAction: null
                });
            };

            const placeBid = () => {
                const nextTurn = (gameState.turnIndex + 1) % gameState.playerSequence.length;
                db.ref(`rooms/${roomId}`).update({
                    currentBid: { ...localBid, playerId: player.id },
                    turnIndex: nextTurn,
                    lastAction: { type: 'BID', playerId: player.id }
                });
                playSound('click');
            };

            const callDudo = () => {
                const bid = gameState.currentBid;
                const allDice = Object.values(gameState.players).flatMap(p => p.dice);
                const count = allDice.filter(d => d === bid.value || (bid.value !== 1 && d === 1)).length;
                const success = count < bid.quantity;
                const loserId = success ? bid.playerId : player.id;
                const winnerId = success ? player.id : bid.playerId;
                
                const newPlayers = { ...gameState.players };
                newPlayers[loserId].diceCount = Math.max(0, newPlayers[loserId].diceCount - 1);

                db.ref(`rooms/${roomId}`).update({
                    phase: 'REVEALED',
                    players: newPlayers,
                    lastAction: { success, loserId, winnerId, actualCount: count, bidWas: bid, caller: player.id }
                });
            };

            // Calculate graveyard (lost dice)
            const lostDiceCount = useMemo(() => {
                if (!gameState) return 0;
                return (gameState.playerSequence.length * 5) - Object.values(gameState.players).reduce((acc, p) => acc + p.diceCount, 0);
            }, [gameState]);

            if (isEditMode) {
                return React.createElement('div', { className: 'h-screen flex flex-col items-center justify-center p-6 space-y-6' },
                    React.createElement('div', { className: 'text-6xl mb-4' }, player.avatar),
                    React.createElement('input', { 
                        className: 'bg-slate-800 p-4 rounded-xl text-center text-2xl border-2 border-yellow-500 w-full max-w-xs',
                        value: player.name, onChange: e => setPlayer({...player, name: e.target.value.substring(0,10)})
                    }),
                    React.createElement('div', { className: 'grid grid-cols-5 gap-2' },
                        AVATARS.map(a => React.createElement('button', { key: a, onClick: () => setPlayer({...player, avatar: a}), className: `text-3xl p-2 rounded ${player.avatar === a ? 'bg-yellow-500' : 'bg-slate-700'}` }, a))
                    ),
                    React.createElement('button', { onClick: () => setIsEditMode(false), className: 'bg-green-600 px-12 py-4 rounded-full text-2xl' }, '‚úÖ')
                );
            }

            if (!gameState) {
                return React.createElement('div', { className: 'h-screen flex flex-col items-center justify-center p-6 space-y-8' },
                    React.createElement('div', { className: 'text-7xl' }, 'üé∞'),
                    React.createElement('button', { onClick: createRoom, className: 'w-64 bg-yellow-500 p-5 rounded-full text-4xl shadow-lg' }, '‚ûï'),
                    React.createElement('div', { className: 'flex space-x-2 w-64' },
                        React.createElement('input', { className: 'flex-1 bg-slate-800 rounded-l-full p-4 text-center text-xl', placeholder: '#', value: roomId, onChange: e => setRoomId(e.target.value) }),
                        React.createElement('button', { onClick: () => joinRoom(), className: 'bg-green-600 px-6 rounded-r-full text-xl' }, '‚û°Ô∏è')
                    )
                );
            }

            const isMyTurn = gameState.phase === 'PLAYING' && gameState.playerSequence[gameState.turnIndex] === player.id;

            return React.createElement('div', { className: 'h-screen flex flex-col' },
                // Header & Graveyard
                React.createElement('div', { className: 'p-4 flex justify-between items-center' },
                    React.createElement('button', { onClick: () => setIsEditMode(true), className: 'text-3xl glass p-2 rounded-full' }, 'üë§'),
                    React.createElement('div', { className: 'flex flex-wrap max-w-[150px] justify-end gap-1 opacity-40' },
                        Array.from({ length: lostDiceCount }).map((_, i) => React.createElement('div', { key: i, className: 'w-3 h-3 bg-white/20 rounded-sm' }))
                    ),
                    React.createElement('button', { onClick: () => { navigator.clipboard.writeText(window.location.href); playSound('click'); }, className: 'text-2xl glass p-2 rounded-full' }, 'üîó')
                ),

                // Opponents
                React.createElement('div', { className: 'flex justify-center space-x-4 p-2' },
                    gameState.playerSequence.map(pid => {
                        const p = gameState.players[pid];
                        const isTurn = gameState.phase === 'PLAYING' && gameState.playerSequence[gameState.turnIndex] === pid;
                        const isWinner = gameState.phase === 'REVEALED' && gameState.lastAction?.winnerId === pid;
                        const isLoser = gameState.phase === 'REVEALED' && gameState.lastAction?.loserId === pid;
                        return React.createElement('div', { key: pid, className: `relative flex flex-col items-center p-2 rounded-2xl transition-all ${isTurn ? 'active-ring scale-110' : 'opacity-60'} ${isWinner ? 'winner-jump' : ''}` },
                            React.createElement('div', { className: 'text-3xl' }, p.avatar),
                            React.createElement('div', { className: 'text-[10px]' }, p.name),
                            React.createElement('div', { className: 'flex space-x-0.5' }, Array.from({ length: p.diceCount }).map((_, i) => React.createElement('div', { key: i, className: 'w-2 h-2 bg-yellow-400 rounded-full' })))
                        );
                    })
                ),

                // Main Area
                React.createElement('div', { className: 'flex-1 flex flex-col items-center justify-center p-4' },
                    // Lobby
                    gameState.phase === 'LOBBY' && React.createElement('div', { className: 'text-center' },
                        React.createElement('div', { className: 'text-6xl animate-bounce mb-8' }, '‚è≥'),
                        gameState.hostId === player.id && React.createElement('button', { onClick: startRound, className: 'bg-green-500 p-6 rounded-full text-4xl' }, '‚ñ∂Ô∏è')
                    ),

                    // Current Bid
                    gameState.phase === 'PLAYING' && gameState.currentBid && React.createElement('div', { className: 'glass p-8 rounded-3xl flex items-center space-x-6' },
                        React.createElement('span', { className: 'text-6xl font-bold' }, gameState.currentBid.quantity),
                        React.createElement('span', { className: 'text-3xl opacity-50' }, '‚úï'),
                        React.createElement(DiceIcon, { value: gameState.currentBid.value, size: 80 })
                    ),

                    // Revelation
                    gameState.phase === 'REVEALED' && React.createElement('div', { className: `w-full glass p-6 rounded-3xl text-center border-4 ${gameState.lastAction.success ? 'border-green-500' : 'border-red-500'}` },
                        React.createElement('div', { className: 'flex flex-wrap justify-center gap-2 mb-6' },
                            Object.values(gameState.players).flatMap(p => p.dice).map((d, i) => 
                                React.createElement(DiceIcon, { key: i, value: d, size: 35, className: (d === gameState.lastAction.bidWas.value || d === 1) ? 'scale-125' : 'opacity-30 grayscale' })
                            )
                        ),
                        React.createElement('div', { className: 'flex items-center justify-center space-x-4 mb-6' },
                             React.createElement('span', { className: 'text-5xl' }, gameState.lastAction.actualCount),
                             React.createElement('span', { className: 'text-2xl' }, '‚û°Ô∏è'),
                             React.createElement(DiceIcon, { value: gameState.lastAction.bidWas.value, size: 50 })
                        ),
                        React.createElement('button', { onClick: startRound, className: 'bg-white text-black px-12 py-3 rounded-full text-2xl font-bold' }, 'üîÑ')
                    )
                ),

                // Controls (My Dice & Betting)
                gameState.phase !== 'LOBBY' && React.createElement('div', { className: 'p-6 space-y-4 bg-black/20 rounded-t-3xl border-t border-white/10' },
                    // My Dice
                    React.createElement('div', { className: 'flex justify-center space-x-2' },
                        gameState.players[player.id]?.dice?.map((d, i) => 
                            React.createElement(DiceIcon, { key: i, value: d, size: 45, className: (gameState.phase === 'REVEALED' && gameState.lastAction.loserId === player.id && i === 0) ? 'losing-die' : '' })
                        )
                    ),
                    
                    // Betting
                    isMyTurn && React.createElement('div', { className: 'space-y-4' },
                        React.createElement('div', { className: 'flex justify-center space-x-8' },
                            React.createElement('div', { className: 'flex items-center space-x-4 glass rounded-full px-4 py-2' },
                                React.createElement('button', { onClick: () => setLocalBid(b => ({...b, quantity: Math.max(1, b.quantity-1)})), className: 'text-3xl' }, '‚ûñ'),
                                React.createElement('span', { className: 'text-4xl font-bold w-12 text-center' }, localBid.quantity),
                                React.createElement('button', { onClick: () => setLocalBid(b => ({...b, quantity: b.quantity+1})), className: 'text-3xl' }, '‚ûï')
                            ),
                            React.createElement('div', { className: 'flex items-center space-x-4 glass rounded-full px-4 py-2' },
                                React.createElement('button', { onClick: () => setLocalBid(b => ({...b, value: b.value === 1 ? 6 : b.value-1})), className: 'text-2xl' }, '‚óÄÔ∏è'),
                                React.createElement(DiceIcon, { value: localBid.value, size: 40 }),
                                React.createElement('button', { onClick: () => setLocalBid(b => ({...b, value: b.value === 6 ? 1 : b.value+1})), className: 'text-2xl' }, '‚ñ∂Ô∏è')
                            )
                        ),
                        React.createElement('div', { className: 'flex space-x-4' },
                            gameState.currentBid && React.createElement('button', { onClick: callDudo, className: 'flex-1 bg-red-600 p-4 rounded-2xl text-4xl shadow-lg' }, 'ü§•'),
                            React.createElement('button', { onClick: placeBid, className: 'flex-[2] bg-green-600 p-4 rounded-2xl text-4xl shadow-lg' }, 'üé≤')
                        )
                    )
                )
            );
        };

        ReactDOM.render(React.createElement(App), document.getElementById('root'));
    </script>
</body>
</html>
