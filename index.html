<!DOCTYPE html>
<html lang="he">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>ðŸŽ² Dudo</title>
<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Fredoka+One&display=swap" rel="stylesheet">
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --gold: #f5c842;
    --felt: #1a5c2a;
    --felt-dark: #0d3318;
    --red: #e84040;
    --green: #2ecc71;
    --text: #f0ead6;
  }

  html, body {
    width: 100%; height: 100%;
    overflow: hidden;
    font-family: 'Fredoka One', cursive;
    background: var(--felt-dark);
    color: var(--text);
    user-select: none;
    touch-action: manipulation;
    -webkit-tap-highlight-color: transparent;
  }

  #root {
    width: 100%;
    height: 100%;
    height: 100dvh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  /* â”€â”€ felt table bg â”€â”€ */
  .felt-bg {
    background:
      radial-gradient(ellipse at 50% 40%, #22723a 0%, #155227 45%, #0b2e18 100%);
  }

  /* â”€â”€ DICE SVG â”€â”€ */
  @keyframes fly-to-pile {
    0%   { transform: translate(0,0) scale(1) rotate(0deg); opacity:1; }
    60%  { transform: translate(var(--fx), var(--fy)) scale(.7) rotate(420deg); opacity:1; }
    100% { transform: translate(var(--fx2), var(--fy2)) scale(.35) rotate(600deg); opacity:0; }
  }
  @keyframes land-in-pile {
    0%   { transform: scale(.3) rotate(-30deg); opacity:0; }
    60%  { transform: scale(1.15) rotate(5deg); opacity:1; }
    100% { transform: scale(1) rotate(var(--pile-rot,0deg)); opacity:1; }
  }
  @keyframes pulse-gold {
    0%,100% { box-shadow: 0 0 0 0 rgba(245,200,66,.5); }
    50%      { box-shadow: 0 0 0 8px rgba(245,200,66,0); }
  }
  @keyframes pop-in {
    0%   { transform: scale(.5); opacity:0; }
    70%  { transform: scale(1.12); }
    100% { transform: scale(1); opacity:1; }
  }
  @keyframes shake {
    0%,100% { transform: translateX(0); }
    20%  { transform: translateX(-6px) rotate(-2deg); }
    40%  { transform: translateX(6px) rotate(2deg); }
    60%  { transform: translateX(-4px); }
    80%  { transform: translateX(4px); }
  }
  @keyframes flash-red {
    0%,100% { background: transparent; }
    30%      { background: rgba(232,64,64,.25); }
  }
  @keyframes flash-green {
    0%,100% { background: transparent; }
    30%      { background: rgba(46,204,113,.2); }
  }
  @keyframes slide-up {
    from { transform: translateY(100%); opacity:0; }
    to   { transform: translateY(0); opacity:1; }
  }
  @keyframes reveal-in {
    0%   { transform: scale(.7) translateY(20px); opacity:0; }
    60%  { transform: scale(1.05) translateY(-4px); }
    100% { transform: scale(1) translateY(0); opacity:1; }
  }
  @keyframes bounce-avatar {
    0%,100% { transform: translateY(0) scale(1); }
    30%      { transform: translateY(-18px) scale(1.25); }
    55%      { transform: translateY(-6px) scale(.95); }
    75%      { transform: translateY(-3px) scale(1.05); }
  }
  @keyframes lose-shake {
    0%,100% { transform: rotate(0deg); }
    20%  { transform: rotate(-8deg); }
    40%  { transform: rotate(8deg); }
    60%  { transform: rotate(-5deg); }
    80%  { transform: rotate(5deg); }
  }

  /* â”€â”€ BUTTONS â”€â”€ */
  .btn {
    border: none; cursor: pointer;
    font-family: 'Fredoka One', cursive;
    transition: transform .1s, box-shadow .1s;
    border-radius: 14px;
  }
  .btn:active { transform: scale(.95); }

  .btn-gold {
    background: linear-gradient(160deg, #f7d060 0%, #e8a820 100%);
    color: #1a1a00;
    box-shadow: 0 4px 12px rgba(0,0,0,.4), inset 0 1px 0 rgba(255,255,255,.3);
  }
  .btn-red {
    background: linear-gradient(160deg, #ff5555 0%, #c01010 100%);
    color: white;
    box-shadow: 0 4px 12px rgba(200,0,0,.35), inset 0 1px 0 rgba(255,255,255,.2);
  }
  .btn-ghost {
    background: rgba(255,255,255,.08);
    color: var(--text);
    border: 2px solid rgba(255,255,255,.18);
  }

  /* â”€â”€ INPUTS â”€â”€ */
  .casino-input {
    background: rgba(0,0,0,.35);
    border: 2px solid rgba(245,200,66,.35);
    border-radius: 12px;
    color: white;
    font-family: 'Fredoka One', cursive;
    outline: none;
    text-align: center;
  }
  .casino-input:focus { border-color: var(--gold); }
  .casino-input::placeholder { color: rgba(255,255,255,.3); }

  /* â”€â”€ PLAYER CARD â”€â”€ */
  .player-card {
    background: rgba(0,0,0,.3);
    border: 2px solid rgba(255,255,255,.1);
    border-radius: 16px;
    padding: 10px 12px;
    text-align: center;
    transition: border-color .25s, background .25s, transform .2s;
    cursor: default;
    flex-shrink: 0;
  }
  .player-card.is-turn {
    border-color: var(--gold);
    background: rgba(245,200,66,.1);
    animation: pulse-gold 1.8s infinite;
    transform: scale(1.07);
  }
  .player-card.result-won {
    border-color: var(--green);
    background: rgba(46,204,113,.12);
  }
  .player-card.result-lost {
    border-color: var(--red);
    background: rgba(232,64,64,.12);
    animation: lose-shake .5s ease;
  }

  /* â”€â”€ PILE DICE â”€â”€ */
  .pile-die {
    display: inline-block;
    margin: 2px;
    transition: transform .3s;
  }
  .pile-die.just-added {
    animation: land-in-pile .45s cubic-bezier(.3,.7,.4,1) both;
  }

  /* â”€â”€ RESULT OVERLAY â”€â”€ */
  .result-overlay {
    position: fixed; inset: 0;
    background: rgba(0,0,0,.88);
    z-index: 100;
    display: flex; flex-direction: column;
    align-items: center; justify-content: flex-start;
    padding: 16px 14px;
    gap: 12px;
    overflow-y: auto;
    animation: slide-up .25s ease;
  }

  /* â”€â”€ CONTROLS PANEL â”€â”€ */
  .controls-panel {
    background: linear-gradient(0deg, rgba(5,20,10,.98) 0%, rgba(10,35,18,.95) 100%);
    border-top: 1.5px solid rgba(245,200,66,.25);
    padding: 12px 14px 12px;
    flex-shrink: 0;
  }

  /* scrollbar hide */
  ::-webkit-scrollbar { display: none; }
</style>
</head>
<body class="felt-bg">
<div id="root"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUDIO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SFX = (() => {
  let ctx;
  const C = () => {
    if (!ctx) ctx = new (window.AudioContext || window.webkitAudioContext)();
    if (ctx.state === 'suspended') ctx.resume();
    return ctx;
  };
  const tone = (type, freq, vol, dur, freqEnd) => {
    const c = C(), o = c.createOscillator(), g = c.createGain();
    o.connect(g); g.connect(c.destination);
    o.type = type; o.frequency.setValueAtTime(freq, c.currentTime);
    if (freqEnd) o.frequency.exponentialRampToValueAtTime(freqEnd, c.currentTime + dur);
    g.gain.setValueAtTime(vol, c.currentTime);
    g.gain.exponentialRampToValueAtTime(.001, c.currentTime + dur);
    o.start(); o.stop(c.currentTime + dur);
  };
  return {
    click:  () => tone('sine', 600, .07, .08, 300),
    win:    () => { tone('triangle',400,.1,.5,1200); setTimeout(()=>tone('triangle',700,.07,.4,1400),200); setTimeout(()=>tone('triangle',900,.05,.35,1600),400); },
    lose:   () => { tone('sawtooth',180,.18,.45,70); setTimeout(()=>tone('sawtooth',100,.12,.3,55),320); },
    place:  () => tone('triangle', 900, .05, .1, 450),
    reveal: () => { tone('square',160,.12,.6,55); setTimeout(()=>tone('sine',280,.08,.35,180),250); },
    shake:  () => {
      const c = C(), sz = c.sampleRate*.3, buf = c.createBuffer(1,sz,c.sampleRate), d = buf.getChannelData(0);
      for (let i=0;i<sz;i++) d[i] = Math.random()*2-1;
      const s = c.createBufferSource(), g = c.createGain();
      g.gain.setValueAtTime(.1,c.currentTime); g.gain.exponentialRampToValueAtTime(.001,c.currentTime+.3);
      s.buffer=buf; s.connect(g); g.connect(c.destination); s.start();
    }
  };
})();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FIREBASE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
firebase.initializeApp({
  apiKey: "AIzaSyCUvDUDrj1MofAFRYeDrGP7OoIz0qX0iW8",
  authDomain: "dudogame-44b81.firebaseapp.com",
  databaseURL: "https://dudogame-44b81-default-rtdb.europe-west1.firebasedatabase.app/",
  projectId: "dudogame-44b81",
  storageBucket: "dudogame-44b81.firebasestorage.app",
  messagingSenderId: "681233339238",
  appId: "1:681233339238:web:c8ed065e83227b6bd22ea7"
});
const db = firebase.database();

const { useState, useEffect, useRef, useCallback } = React;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONSTANTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const AVATARS = ['ðŸ˜Ž','ðŸ¤ ','ðŸ‘½','ðŸ‘»','ðŸ¤–','ðŸ¦Š','ðŸ¦','ðŸ¦„','ðŸ¸','ðŸµ','ðŸ¯','ðŸ¦…','ðŸ²','ðŸ’€','ðŸŽ­'];
const rollDice = n => Array.from({length:n}, () => Math.floor(Math.random()*6)+1);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DICE SVG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const DOTS = {
  1:[[50,50]], 2:[[28,28],[72,72]], 3:[[28,28],[50,50],[72,72]],
  4:[[28,28],[72,28],[28,72],[72,72]], 5:[[28,28],[72,28],[50,50],[28,72],[72,72]],
  6:[[28,28],[28,50],[28,72],[72,28],[72,50],[72,72]]
};
const Dice = ({ val, size=44, bright=false, dim=false, style={} }) => {
  const isAce = val===1;
  const face = bright ? '#1a5c2a' : (isAce ? '#7a0a0a' : '#1a1a2e');
  const border = bright ? '#2ecc71' : (isAce ? '#e84040' : 'rgba(255,255,255,.3)');
  const glow = bright ? 'drop-shadow(0 0 6px #2ecc71)' : (isAce ? 'drop-shadow(0 0 4px #e84040)' : 'drop-shadow(1px 2px 4px rgba(0,0,0,.7))');
  return React.createElement('svg', {
    width:size, height:size, viewBox:'0 0 100 100',
    style:{ opacity: dim?.6:1, filter:glow, flexShrink:0, ...style }
  },
    React.createElement('defs', null,
      React.createElement('linearGradient', { id:`dg${val}${size}${bright?'b':''}`, x1:'0%', y1:'0%', x2:'100%', y2:'100%' },
        React.createElement('stop', { offset:'0%', stopColor: bright?'#2e7d45':(isAce?'#900':'#252545') }),
        React.createElement('stop', { offset:'100%', stopColor: bright?'#0d3318':(isAce?'#500':'#0d0d1a') })
      )
    ),
    React.createElement('rect', { x:5,y:5,width:90,height:90,rx:16,
      fill:`url(#dg${val}${size}${bright?'b':''})`, stroke:border, strokeWidth: bright?4:2 }),
    (DOTS[val]||[]).map(([cx,cy],i) =>
      React.createElement('circle', { key:i, cx, cy, r: isAce?11:7.5,
        fill: bright ? '#a8ffcc' : (isAce?'#ff5555':'white') })
    )
  );
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PILE COMPONENT (side pile of lost dice)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const DicePile = ({ count, justAdded }) => {
  // Generate stable random rotations seeded by index
  const rotations = Array.from({length: Math.min(count, 15)}, (_,i) => {
    const seed = (i * 137 + 29) % 360;
    return -25 + (seed % 50);
  });

  return React.createElement('div', {
    style:{
      display:'flex', flexWrap:'wrap', justifyContent:'center', alignItems:'center',
      gap:2, padding:8,
      background:'rgba(0,0,0,.35)',
      border:'1.5px solid rgba(255,255,255,.1)',
      borderRadius:14, minWidth:56, minHeight:56
    }
  },
    rotations.map((rot,i) =>
      React.createElement('div', {
        key:i,
        className: `pile-die ${i === count-1 && justAdded ? 'just-added' : ''}`,
        style:{ transform:`rotate(${rot}deg)`, '--pile-rot':`${rot}deg` }
      },
        React.createElement(Dice, { val:1+(i%6), size:20, dim:true })
      )
    )
  );
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PLAYER CARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const PlayerCard = ({ p, isActive, resultState, isMe, onEditAvatar, onEditName }) => {
  const [editingName, setEditingName] = useState(false);
  const [tmpName, setTmpName] = useState(p.name);

  const saveName = () => {
    setEditingName(false);
    const n = tmpName.trim().substring(0,12);
    if (n) onEditName && onEditName(n);
    else setTmpName(p.name);
  };

  const cls = `player-card${isActive?' is-turn':''}${resultState==='won'?' result-won':''}${resultState==='lost'?' result-lost':''}`;

  return React.createElement('div', { className: cls, style:{ minWidth:64, maxWidth:76 } },
    // Avatar â€” clickable if mine
    React.createElement('div', {
      style:{ fontSize:30, lineHeight:1, cursor: isMe?'pointer':'default',
        transition:'transform .15s' },
      onClick: isMe ? onEditAvatar : undefined,
      title: isMe ? 'ðŸ‘†' : ''
    }, p.avatar),

    // Name â€” editable if mine
    editingName
      ? React.createElement('input', {
          autoFocus:true,
          value:tmpName,
          onChange:e=>setTmpName(e.target.value.substring(0,12)),
          onBlur:saveName,
          onKeyDown:e=>{ if(e.key==='Enter') saveName(); if(e.key==='Escape'){ setEditingName(false); setTmpName(p.name); } },
          style:{ background:'transparent', border:'none', borderBottom:'2px solid #f5c842',
            color:'white', fontFamily:"'Fredoka One', cursive", fontSize:'.72rem',
            textAlign:'center', outline:'none', width:64, marginTop:3 }
        })
      : React.createElement('div', {
          style:{ fontSize:'.72rem', marginTop:3, overflow:'hidden',
            textOverflow:'ellipsis', whiteSpace:'nowrap', maxWidth:70, margin:'3px auto 0',
            color: isMe ? '#f5c842' : 'rgba(255,255,255,.85)',
            cursor: isMe ? 'pointer' : 'default' },
          onClick: isMe ? ()=>{ setTmpName(p.name); setEditingName(true); } : undefined
        }, p.name)
  );
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CURRENT BID CENTER DISPLAY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const BidCenter = ({ bid, players }) => {
  if (!bid) return React.createElement('div', {
    style:{ fontSize:'.9rem', color:'rgba(255,255,255,.3)', letterSpacing:3, textAlign:'center' }
  }, 'Â· Â· Â·');

  const bidder = players?.[bid.playerId];
  return React.createElement('div', {
    style:{
      display:'flex', flexDirection:'column', alignItems:'center', gap:6,
      background:'rgba(0,0,0,.4)', border:'2px solid rgba(245,200,66,.3)',
      borderRadius:20, padding:'12px 24px',
      animation:'pop-in .3s ease'
    }
  },
    React.createElement('div', {
      style:{ display:'flex', alignItems:'center', gap:12 }
    },
      React.createElement('span', {
        style:{ fontSize:'2.8rem', fontWeight:'bold', color:'white',
          textShadow:'0 0 8px rgba(245,200,66,.5)' }
      }, bid.quantity),
      React.createElement('span', { style:{ fontSize:'1.4rem', opacity:.4 } }, 'Ã—'),
      React.createElement(Dice, { val:bid.value, size:52 })
    ),
    bidder && React.createElement('div', {
      style:{ fontSize:'.75rem', color:'rgba(255,255,255,.5)',
        display:'flex', alignItems:'center', gap:4 }
    }, bidder.avatar, ' ', bidder.name)
  );
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RESULT SCREEN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const ResultScreen = ({ gs, myId, onNext, pileRef }) => {
  const la = gs.lastAction;
  if (!la) return null;

  const [flyingDie, setFlyingDie] = useState(false);

  useEffect(() => {
    // Trigger flying-die animation shortly after mount
    setTimeout(() => setFlyingDie(true), 600);
  }, []);

  const callerWon = la.success;
  const caller  = gs.players[la.caller];
  const bidder  = gs.players[la.bidder];
  const loser   = gs.players[la.loserId];
  const bidVal  = la.bidWas?.value;
  const isMe    = myId === la.caller;
  const iLost   = myId === la.loserId;

  const allPlayerDice = gs.playerSequence.map(pid => ({
    pid, p: gs.players[pid], dice: gs.players[pid]?.dice || []
  })).filter(x => x.dice.length > 0);

  return React.createElement('div', { className:'result-overlay' },

    // â”€â”€ TOP: WHO LOST â”€â”€
    React.createElement('div', {
      style:{
        width:'100%', maxWidth:360, borderRadius:20,
        border:`3px solid ${callerWon ? '#2ecc71' : '#e84040'}`,
        background: callerWon ? 'rgba(20,80,40,.9)' : 'rgba(80,10,10,.9)',
        padding:'14px 18px', textAlign:'center',
        boxShadow:`0 0 24px ${callerWon?'rgba(46,204,113,.4)':'rgba(232,64,64,.4)'}`,
        animation:'reveal-in .4s cubic-bezier(.3,.7,.4,1) both',
        position:'relative', overflow:'hidden'
      }
    },
      // Caller & Bidder avatars
      React.createElement('div', {
        style:{ display:'flex', alignItems:'center', justifyContent:'center', gap:14, marginBottom:10 }
      },
        React.createElement('div', {
          style:{ fontSize:36, animation: callerWon ? 'bounce-avatar .7s ease' : 'lose-shake .5s ease' }
        }, caller?.avatar),
        React.createElement('span', { style:{ fontSize:20, opacity:.6 } }, callerWon ? 'âœ‹' : 'ðŸ˜¬'),
        React.createElement('div', {
          style:{ fontSize:36, animation: !callerWon ? 'bounce-avatar .7s ease' : 'lose-shake .5s ease' }
        }, bidder?.avatar)
      ),

      // Result indicator
      React.createElement('div', {
        style:{
          fontSize:'1.8rem', marginBottom:8,
          animation:`${callerWon?'flash-green':'flash-red'} .6s ease`
        }
      }, callerWon ? (isMe ? 'ðŸŽ‰' : 'âœ…') : (iLost ? 'ðŸ’€' : 'âŒ')),

      // Actual count vs bid
      React.createElement('div', {
        style:{ display:'flex', alignItems:'center', justifyContent:'center', gap:10, marginBottom:6 }
      },
        React.createElement('span', {
          style:{ fontSize:'2rem', fontWeight:'bold',
            color: la.actualCount >= la.bidWas?.quantity ? '#2ecc71' : '#e84040' }
        }, la.actualCount),
        React.createElement('span', { style:{ opacity:.4, fontSize:'1.2rem' } }, 'Ã—'),
        React.createElement(Dice, { val:bidVal||2, size:36 }),
        React.createElement('span', { style:{ opacity:.4, fontSize:'1rem' } }, '/ '+la.bidWas?.quantity)
      ),

      // Loser
      React.createElement('div', {
        style:{ fontSize:'.85rem', color: '#e84040', marginTop:4,
          display:'flex', alignItems:'center', justifyContent:'center', gap:6 }
      }, loser?.avatar, ' ', loser?.name, ' âˆ’1 ðŸŽ²')
    ),

    // â”€â”€ ALL DICE REVEALED â”€â”€
    React.createElement('div', { style:{ width:'100%', maxWidth:360 } },
      allPlayerDice.map(({pid, p, dice}) =>
        React.createElement('div', {
          key:pid,
          style:{
            display:'flex', alignItems:'center', gap:8, marginBottom:8,
            background:'rgba(255,255,255,.05)', borderRadius:12, padding:'7px 10px'
          }
        },
          React.createElement('span', { style:{fontSize:22, flexShrink:0} }, p.avatar),
          React.createElement('div', { style:{display:'flex', gap:4, flexWrap:'wrap', alignItems:'center'} },
            dice.map((d,i) => {
              const match = d===bidVal || (bidVal!==1 && d===1);
              return React.createElement(Dice, { key:i, val:d, size:34, bright:match, dim:!match });
            })
          ),
          // Show if this player lost a die
          pid === la.loserId && React.createElement('span', {
            style:{ fontSize:16, color:'#e84040', flexShrink:0, marginLeft:'auto' }
          }, 'âˆ’1')
        )
      )
    ),

    // â”€â”€ NEXT ROUND BUTTON â”€â”€
    React.createElement('button', {
      className:'btn btn-gold',
      style:{ width:'100%', maxWidth:360, padding:'15px 0', fontSize:'1.3rem' },
      onClick: onNext
    }, 'â–¶')
  );
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MAIN APP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const App = () => {
  // â”€â”€ State â”€â”€
  const [player, setPlayer] = useState(() => {
    const s = JSON.parse(sessionStorage.getItem('dudo_p') || '{}');
    return {
      id:     s.id     || Math.random().toString(36).substring(2,9),
      name:   s.name   || 'Player',
      avatar: s.avatar || AVATARS[Math.floor(Math.random()*AVATARS.length)]
    };
  });
  const [gs, setGs]             = useState(null);
  const [roomId, setRoomId]     = useState('');
  const [roomInput, setRoomInput] = useState('');
  const [bid, setBid]           = useState({ qty:1, val:2 });
  const [showResult, setShowResult] = useState(false);
  const [copied, setCopied]     = useState(false);
  const [pileJustAdded, setPileJustAdded] = useState(false);
  const [notification, setNotification] = useState(null);
  const [flashClass, setFlashClass] = useState('');

  const prevPhase = useRef(null);
  const prevPile  = useRef(0);

  // â”€â”€ Persist player â”€â”€
  useEffect(() => {
    sessionStorage.setItem('dudo_p', JSON.stringify(player));
    if (roomId) {
      db.ref(`rooms/${roomId}/players/${player.id}/name`).set(player.name);
      db.ref(`rooms/${roomId}/players/${player.id}/avatar`).set(player.avatar);
    }
  }, [player]);

  // â”€â”€ Auto-join from URL â”€â”€
  useEffect(() => {
    const code = new URLSearchParams(window.location.search).get('room');
    if (code && code.length===4) {
      setRoomInput(code);
      joinRoom(code);
    }
  }, []);

  // â”€â”€ Firebase listener â”€â”€
  useEffect(() => {
    if (!roomId) return;
    const ref = db.ref(`rooms/${roomId}`);
    ref.on('value', snap => {
      const val = snap.val();
      if (!val) return;
      const prev = prevPhase.current;

      if (val.phase==='REVEALED' && prev!=='REVEALED') {
        SFX.reveal();
        setFlashClass('flash-red');
        setTimeout(()=>setFlashClass(''), 700);
        setShowResult(true);
      }
      if (val.phase==='PLAYING' && prev==='REVEALED') {
        setShowResult(false);
        SFX.shake();
        // Check if pile grew
        const newPile = val.tableDice||0;
        if (newPile > (prevPile.current||0)) {
          setPileJustAdded(true);
          setTimeout(()=>setPileJustAdded(false), 800);
        }
        prevPile.current = newPile;
        setBid({qty:1, val:2});
      }
      if (val.phase==='WON' && prev!=='WON') {
        SFX.win();
        confetti({ particleCount:180, spread:80, origin:{y:.5}, colors:['#f5c842','#2ecc71','#ff6b6b'] });
        setTimeout(()=>confetti({ particleCount:80, spread:120, origin:{x:.1,y:.3} }), 500);
        setTimeout(()=>confetti({ particleCount:80, spread:120, origin:{x:.9,y:.3} }), 700);
      }
      if (val.phase==='PLAYING' && val.currentBid && prev==='PLAYING') {
        setBid(val.currentBid ? {qty:val.currentBid.quantity, val:val.currentBid.value} : {qty:1,val:2});
      }

      prevPhase.current = val.phase;
      setGs(val);
    });
    return () => ref.off();
  }, [roomId]);

  // â”€â”€ Room actions â”€â”€
  const createRoom = () => {
    const code = Math.floor(1000+Math.random()*9000).toString();
    const init = {
      roomId:code, hostId:player.id, phase:'LOBBY',
      turnIndex:0, playerSequence:[player.id], tableDice:0,
      players:{ [player.id]: {...player, diceCount:5, dice:[]} }
    };
    db.ref(`rooms/${code}`).set(init);
    setRoomId(code);
    setGs(init);
    SFX.click();
    window.history.pushState({}, '', `?room=${code}`);
  };

  const joinRoom = (code) => {
    const c = (code||roomInput||'').toString().trim().toUpperCase();
    if (!c || c.length!==4) return;
    db.ref(`rooms/${c}`).transaction(room => {
      if (!room) return room;
      if (!room.players[player.id]) {
        const vals = Object.values(room.players);
        const minDice = room.phase==='PLAYING' ? Math.min(...vals.map(p=>p.diceCount)) : 5;
        room.players[player.id] = {...player, diceCount:minDice, dice:[]};
        room.playerSequence = room.playerSequence || [];
        if (!room.playerSequence.includes(player.id)) room.playerSequence.push(player.id);
      }
      return room;
    }, (err, committed, snap) => {
      const val = snap && snap.val();
      if (val) {
        setRoomId(c);
        setGs(val);
        SFX.click();
        window.history.pushState({}, '', `?room=${c}`);
      } else {
        notify('âŒ');
      }
    });
  };

  const startGame = () => {
    const np = {...gs.players};
    Object.keys(np).forEach(pid => { np[pid].dice = rollDice(np[pid].diceCount); });
    db.ref(`rooms/${roomId}`).update({ phase:'PLAYING', players:np, currentBid:null, turnIndex:0, lastAction:null });
    SFX.shake();
  };

  const placeBid = () => {
    const cur = gs.currentBid;
    if (cur) {
      const ok = bid.qty > cur.quantity || (bid.qty===cur.quantity && bid.val>cur.value);
      if (!ok) { SFX.lose(); notify('â¬†ï¸'); return; }
    }
    const next = (gs.turnIndex+1) % gs.playerSequence.length;
    db.ref(`rooms/${roomId}`).update({
      currentBid: { quantity:bid.qty, value:bid.val, playerId:player.id },
      turnIndex: next
    });
    SFX.place();
  };

  const callDudo = () => {
    const cb = gs.currentBid;
    const allDice = Object.values(gs.players).flatMap(p=>p.dice||[]);
    const count = allDice.filter(d => d===cb.value || (cb.value!==1 && d===1)).length;
    const callerWon = count < cb.quantity;
    const loserId = callerWon ? cb.playerId : player.id;
    const np = {...gs.players};
    np[loserId] = { ...np[loserId], diceCount: Math.max(0, np[loserId].diceCount-1) };
    db.ref(`rooms/${roomId}`).update({
      phase:'REVEALED', players:np,
      lastAction:{ type:'DUDO', caller:player.id, bidder:cb.playerId,
        success:callerWon, loserId, actualCount:count, bidWas:cb }
    });
    callerWon ? SFX.win() : SFX.lose();
  };

  const nextRound = () => {
    const np = {...gs.players};
    const alive = gs.playerSequence.filter(pid => (np[pid]?.diceCount||0) > 0);
    if (alive.length===1) {
      db.ref(`rooms/${roomId}`).update({ phase:'WON', winnerId:alive[0] });
      return;
    }
    const newPile = (gs.tableDice||0) + 1;
    alive.forEach(pid => { np[pid].dice = rollDice(np[pid].diceCount); });
    db.ref(`rooms/${roomId}`).update({
      phase:'PLAYING', players:np, playerSequence:alive,
      turnIndex:0, currentBid:null, lastAction:null, tableDice:newPile
    });
  };

  const shareRoom = () => {
    const url = `${window.location.origin}${window.location.pathname}?room=${roomId}`;
    navigator.clipboard.writeText(url).catch(()=>{});
    setCopied(true);
    setTimeout(()=>setCopied(false), 2200);
    SFX.click();
  };

  const notify = (msg) => {
    setNotification(msg);
    setTimeout(()=>setNotification(null), 1800);
  };

  const nextAvatar = () => {
    const i = AVATARS.indexOf(player.avatar);
    setPlayer(p => ({...p, avatar: AVATARS[(i+1)%AVATARS.length]}));
  };

  // â”€â”€ Derived â”€â”€
  const me = gs?.players?.[player.id];
  const isMyTurn = gs?.phase==='PLAYING' && gs.playerSequence[gs.turnIndex]===player.id;
  const activeId = gs?.playerSequence[gs?.turnIndex];

  const getResultState = pid => {
    if (!gs?.lastAction || gs.phase!=='REVEALED') return null;
    const la = gs.lastAction;
    if (pid===la.loserId) return 'lost';
    if (pid===la.caller && la.success) return 'won';
    return null;
  };

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // LOBBY SCREEN
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  if (!gs) return React.createElement('div', {
    style:{
      width:'100%', height:'100%', height:'100dvh',
      display:'flex', flexDirection:'column', alignItems:'center', justifyContent:'center',
      gap:20, padding:'20px 24px'
    }
  },
    // Giant dice icon
    React.createElement('div', { style:{fontSize:'5rem', lineHeight:1, animation:'bounce-avatar 2.5s ease infinite'} }, 'ðŸŽ²'),

    // Create button
    React.createElement('button', {
      className:'btn btn-gold',
      style:{ width:'100%', maxWidth:300, padding:'16px 0', fontSize:'1.4rem' },
      onClick: createRoom
    }, 'ï¼‹'),

    // Join row
    React.createElement('div', { style:{display:'flex', gap:8, width:'100%', maxWidth:300} },
      React.createElement('input', {
        className:'casino-input',
        value:roomInput,
        onChange:e=>setRoomInput(e.target.value.substring(0,4).toUpperCase()),
        onKeyDown:e=>{ if(e.key==='Enter') joinRoom(); },
        placeholder:'####',
        style:{ flex:1, padding:'14px 10px', fontSize:'1.3rem', letterSpacing:8 }
      }),
      React.createElement('button', {
        className:'btn btn-ghost',
        style:{ padding:'14px 20px', fontSize:'1.2rem', borderRadius:12 },
        onClick:()=>joinRoom()
      }, 'â–¶')
    ),

    notification && React.createElement('div', {
      style:{
        position:'fixed', top:'40%', left:'50%', transform:'translate(-50%,-50%)',
        background:'rgba(232,64,64,.9)', borderRadius:20, padding:'10px 24px',
        fontSize:'1.5rem', zIndex:999, animation:'pop-in .2s ease'
      }
    }, notification)
  );

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // GAME SCREEN
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  const allPlayers = gs.playerSequence.map(pid => gs.players[pid]).filter(Boolean);

  return React.createElement('div', {
    style:{
      width:'100%', height:'100%', height:'100dvh',
      display:'flex', flexDirection:'column', overflow:'hidden',
      animation: flashClass ? `${flashClass} .5s ease` : 'none'
    }
  },

    // â”€â”€ RESULT OVERLAY â”€â”€
    showResult && gs.phase==='REVEALED' && gs.lastAction &&
    React.createElement(ResultScreen, { gs, myId:player.id, onNext:nextRound }),

    // â”€â”€ WIN SCREEN â”€â”€
    gs.phase==='WON' && gs.winnerId && React.createElement('div', {
      style:{
        position:'fixed', inset:0, zIndex:200,
        background:'radial-gradient(ellipse, #0f3d1a 0%, #050d08 100%)',
        display:'flex', flexDirection:'column', alignItems:'center', justifyContent:'center',
        gap:14, textAlign:'center', padding:20
      }
    },
      React.createElement('div', { style:{fontSize:'5rem', animation:'bounce-avatar 1s infinite'} }, 'ðŸ†'),
      React.createElement('div', { style:{fontSize:'3.5rem'} }, gs.players[gs.winnerId]?.avatar),
      React.createElement('div', {
        style:{ fontSize:'1.8rem', color:'#f5c842',
          textShadow:'0 0 12px rgba(245,200,66,.7)', letterSpacing:2 }
      }, gs.players[gs.winnerId]?.name),
      gs.hostId===player.id && React.createElement('button', {
        className:'btn btn-gold',
        style:{ marginTop:8, padding:'14px 40px', fontSize:'1.1rem' },
        onClick:startGame
      }, 'ðŸ”„')
    ),

    // â”€â”€ HEADER â”€â”€
    React.createElement('div', {
      style:{
        display:'flex', justifyContent:'space-between', alignItems:'center',
        padding:'8px 12px', flexShrink:0,
        background:'rgba(0,0,0,.3)', borderBottom:'1px solid rgba(255,255,255,.08)'
      }
    },
      // Room code + share
      React.createElement('div', { style:{display:'flex', alignItems:'center', gap:6} },
        React.createElement('span', {
          style:{ fontFamily:'monospace', fontSize:'1.3rem', color:'#f5c842', letterSpacing:4 }
        }, roomId),
        React.createElement('button', {
          className:'btn btn-ghost',
          style:{ padding:'4px 10px', fontSize:'.8rem', borderRadius:10, border:'1px solid rgba(255,255,255,.15)' },
          onClick:shareRoom
        }, copied ? 'âœ…' : 'ðŸ”—')
      ),

      // My card in header (tap avatar to cycle, tap name to edit)
      me && React.createElement(PlayerCard, {
        p:{ ...me, name:player.name, avatar:player.avatar },
        isActive:false, resultState:null, isMe:true,
        onEditAvatar:nextAvatar,
        onEditName:n=>setPlayer(p=>({...p,name:n}))
      })
    ),

    // â”€â”€ TABLE AREA â”€â”€
    React.createElement('div', {
      style:{
        flex:1, display:'flex', flexDirection:'column',
        alignItems:'center', justifyContent:'space-between',
        padding:'8px 10px', overflow:'hidden', gap:8
      }
    },

      // â”€â”€ PLAYERS ROW â”€â”€
      React.createElement('div', {
        style:{
          display:'flex', justifyContent:'center', flexWrap:'wrap',
          gap:8, width:'100%'
        }
      },
        allPlayers.map(p =>
          React.createElement(PlayerCard, {
            key:p.id||p.name,
            p,
            isActive: activeId===p.id && gs.phase==='PLAYING',
            resultState: getResultState(p.id),
            isMe: p.id===player.id,
            onEditAvatar: p.id===player.id ? nextAvatar : undefined,
            onEditName: p.id===player.id ? n=>setPlayer(pp=>({...pp,name:n})) : undefined
          })
        )
      ),

      // â”€â”€ CENTER: BID + PILE â”€â”€
      React.createElement('div', {
        style:{
          display:'flex', alignItems:'center', justifyContent:'center', gap:16,
          flex:1, width:'100%'
        }
      },
        // Dice pile (left side)
        (gs.tableDice > 0) && React.createElement(DicePile, {
          count: gs.tableDice,
          justAdded: pileJustAdded
        }),

        // Current bid (center)
        React.createElement('div', { style:{flex:1, display:'flex', justifyContent:'center'} },
          gs.phase==='PLAYING'
            ? React.createElement(BidCenter, { bid:gs.currentBid, players:gs.players })
            : gs.phase==='LOBBY'
              ? React.createElement('div', {
                  style:{display:'flex', flexDirection:'column', alignItems:'center', gap:12}
                },
                  React.createElement('div', {
                    style:{fontSize:'2.2rem', opacity:.5, animation:'spin 6s linear infinite'}
                  }, 'âš™ï¸'),
                  React.createElement('div', {
                    style:{fontSize:'1rem', color:'rgba(255,255,255,.4)', letterSpacing:2}
                  }, gs.playerSequence.length + ' ðŸŽ®'),
                  gs.hostId===player.id && React.createElement('button', {
                    className:'btn btn-gold',
                    style:{padding:'14px 40px', fontSize:'1.3rem', marginTop:4},
                    onClick:startGame
                  }, 'â–¶')
                )
              : null
        )
      )
    ),

    // â”€â”€ CONTROLS â”€â”€
    isMyTurn && gs.phase==='PLAYING' && React.createElement('div', { className:'controls-panel' },
      // My dice (always visible above controls when it's my turn)
      me?.dice?.length > 0 && React.createElement('div', {
        style:{display:'flex', justifyContent:'center', gap:6, marginBottom:10}
      },
        me.dice.map((d,i) => React.createElement(Dice, { key:i, val:d, size:40 }))
      ),

      // Bid selectors row
      React.createElement('div', {
        style:{display:'flex', alignItems:'center', justifyContent:'center', gap:10, marginBottom:10}
      },
        // Quantity [ âˆ’ N + ]
        React.createElement('div', {
          style:{display:'flex', alignItems:'center', gap:6,
            background:'rgba(255,255,255,.07)', borderRadius:14, padding:'5px 10px'}
        },
          React.createElement('button', {
            className:'btn btn-ghost',
            style:{width:34, height:34, padding:0, fontSize:'1.3rem', borderRadius:'50%', border:'none'},
            onClick:()=>setBid(b=>({...b, qty:Math.max(1,b.qty-1)}))
          }, 'âˆ’'),
          React.createElement('span', {
            style:{fontSize:'2rem', fontWeight:'bold', minWidth:36, textAlign:'center', color:'white'}
          }, bid.qty),
          React.createElement('button', {
            className:'btn btn-ghost',
            style:{width:34, height:34, padding:0, fontSize:'1.3rem', borderRadius:'50%', border:'none'},
            onClick:()=>setBid(b=>({...b, qty:b.qty+1}))
          }, '+')
        ),

        React.createElement('span', { style:{opacity:.3, fontSize:'1.2rem'} }, 'Ã—'),

        // Die face [ â€¹ D â€º ]
        React.createElement('div', {
          style:{display:'flex', alignItems:'center', gap:6,
            background:'rgba(255,255,255,.07)', borderRadius:14, padding:'5px 10px'}
        },
          React.createElement('button', {
            className:'btn btn-ghost',
            style:{width:34, height:34, padding:0, fontSize:'1.3rem', borderRadius:'50%', border:'none'},
            onClick:()=>setBid(b=>({...b, val:b.val===1?6:b.val-1}))
          }, 'â€¹'),
          React.createElement(Dice, { val:bid.val, size:42 }),
          React.createElement('button', {
            className:'btn btn-ghost',
            style:{width:34, height:34, padding:0, fontSize:'1.3rem', borderRadius:'50%', border:'none'},
            onClick:()=>setBid(b=>({...b, val:b.val===6?1:b.val+1}))
          }, 'â€º')
        )
      ),

      // Action buttons
      React.createElement('div', { style:{display:'flex', gap:8} },
        gs.currentBid && React.createElement('button', {
          className:'btn btn-red',
          style:{flex:1, padding:'13px 0', fontSize:'1.4rem'},
          onClick:callDudo
        }, 'ðŸš¨'),
        React.createElement('button', {
          className:'btn btn-gold',
          style:{flex:2, padding:'13px 0', fontSize:'1.4rem'},
          onClick:placeBid
        }, 'ðŸŽ¯')
      )
    ),

    // When not my turn â€” show my dice quietly
    !isMyTurn && gs.phase==='PLAYING' && me?.dice?.length > 0 &&
    React.createElement('div', {
      style:{
        padding:'8px 14px 10px', display:'flex', justifyContent:'center', gap:6,
        background:'rgba(0,0,0,.25)', borderTop:'1px solid rgba(255,255,255,.06)', flexShrink:0
      }
    },
      me.dice.map((d,i) => React.createElement(Dice, { key:i, val:d, size:38 }))
    ),

    // Toast notification
    notification && React.createElement('div', {
      style:{
        position:'fixed', top:'45%', left:'50%', transform:'translate(-50%,-50%)',
        background:'rgba(232,64,64,.9)', borderRadius:16, padding:'10px 24px',
        fontSize:'1.5rem', zIndex:999, pointerEvents:'none',
        animation:'pop-in .2s ease'
      }
    }, notification)
  );
};

// â”€â”€ SPIN keyframe fix for spin â”€â”€
const style = document.createElement('style');
style.textContent = `@keyframes spin { from{transform:rotate(0deg)} to{transform:rotate(360deg)} }`;
document.head.appendChild(style);

ReactDOM.render(React.createElement(App), document.getElementById('root'));
</script>
</body>
</html>
