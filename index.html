<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LADODO - Visual Edition</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        body { 
            background: radial-gradient(circle at center, #1a1a2e 0%, #000000 100%);
            color: white; 
            user-select: none; 
            font-family: sans-serif; 
            overflow: hidden;
            touch-action: manipulation;
        }

        /* Animations */
        @keyframes bounce-win {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-30px) scale(1.2); }
        }
        @keyframes shake-lose {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            10% { transform: translate(-3px, -2px) rotate(-5deg); }
            30% { transform: translate(3px, 2px) rotate(5deg); }
            50% { transform: translate(-3px, 1px) rotate(-5deg); }
            100% { transform: translate(0, 0) rotate(0); }
        }
        @keyframes pulse-turn {
            0% { box-shadow: 0 0 0 0 rgba(250, 204, 21, 0.4); }
            70% { box-shadow: 0 0 0 15px rgba(250, 204, 21, 0); }
            100% { box-shadow: 0 0 0 0 rgba(250, 204, 21, 0); }
        }

        .winner-anim { animation: bounce-win 0.6s infinite; z-index: 50; }
        .loser-anim { animation: shake-lose 0.5s infinite; filter: sepia(1) hue-rotate(-50deg) saturate(3); z-index: 50; }
        
        .active-turn {
            border: 3px solid #facc15; /* Yellow */
            animation: pulse-turn 1.5s infinite;
            background: rgba(250, 204, 21, 0.1);
        }

        .dice-3d { filter: drop-shadow(2px 4px 6px black); }
        .dead-dice { filter: grayscale(1) opacity(0.3); }
        
        /* Glassmorphism */
        .glass { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(5px); border: 1px solid rgba(255,255,255,0.1); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script>
        // --- SOUNDS ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const playTone = (freq, type, dur) => {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.frequency.value = freq;
            osc.type = type;
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            gain.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + dur);
            osc.stop(audioCtx.currentTime + dur);
        };

        const Sounds = {
            click: () => playTone(600, 'sine', 0.1),
            error: () => playTone(150, 'sawtooth', 0.4),
            win: () => { playTone(400, 'square', 0.1); setTimeout(() => playTone(600, 'square', 0.2), 100); },
            reveal: () => playTone(800, 'triangle', 0.5)
        };

        // --- FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyCUvDUDrj1MofAFRYeDrGP7OoIz0qX0iW8",
            authDomain: "dudogame-44b81.firebaseapp.com",
            databaseURL: "https://dudogame-44b81-default-rtdb.europe-west1.firebasedatabase.app/",
            projectId: "dudogame-44b81",
            storageBucket: "dudogame-44b81.firebasestorage.app",
            messagingSenderId: "681233339238",
            appId: "1:681233339238:web:c8ed065e83227b6bd22ea7"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        const { useState, useEffect } = React;

        // --- COMPONENTS ---
        const Dice = ({ val, size=40, highlight=false }) => {
            const dots = {
                1: [[50,50]], 2: [[25,25],[75,75]], 3: [[25,25],[50,50],[75,75]],
                4: [[25,25],[25,75],[75,25],[75,75]], 5: [[25,25],[25,75],[50,50],[75,25],[75,75]],
                6: [[25,25],[25,50],[25,75],[75,25],[75,50],[75,75]]
            };
            return React.createElement('svg', { width: size, height: size, viewBox: '0 0 100 100', className: `dice-3d transition-all ${highlight ? 'scale-125 z-10' : ''}` },
                React.createElement('rect', { x:5, y:5, width:90, height:90, rx:15, fill: val===1 && !highlight ? '#ef4444' : (highlight ? '#22c55e' : 'white') }),
                dots[val]?.map(([cx,cy],i) => React.createElement('circle', { key:i, cx, cy, r:8, fill: 'black' }))
            );
        };

        const Avatar = ({ icon, name, diceCount, state, isActive, onClick }) => {
            return React.createElement('div', { onClick, className: `relative flex flex-col items-center p-2 rounded-xl transition-all duration-300 ${isActive ? 'active-turn scale-110' : 'opacity-80'} ${state === 'win' ? 'winner-anim' : ''} ${state === 'lose' ? 'loser-anim' : ''}` },
                React.createElement('div', { className: 'text-4xl filter drop-shadow-md' }, icon),
                React.createElement('div', { className: 'font-bold text-xs bg-black/50 px-2 rounded mt-1' }, name),
                React.createElement('div', { className: 'flex gap-1 mt-1' },
                    Array.from({length: Math.max(0, diceCount)}).map((_,i) => 
                        React.createElement('div', { key:i, className: 'w-2 h-2 rounded-full bg-yellow-400 shadow-md' })
                    )
                )
            );
        };

        const App = () => {
            // Player Local State
            const [me, setMe] = useState(() => JSON.parse(sessionStorage.getItem('ladodo_me') || `{"id":"${Math.random().toString(36).substring(2,7)}","name":"Player","icon":"ðŸ˜Ž"}`));
            const [roomId, setRoomId] = useState(new URLSearchParams(window.location.search).get('room') || '');
            const [roomState, setRoomState] = useState(null);
            
            // UI State
            const [editing, setEditing] = useState(false);
            const [bid, setBid] = useState({ q: 1, v: 2 });
            const [cupOpen, setCupOpen] = useState(true);

            // Sync User
            useEffect(() => sessionStorage.setItem('ladodo_me', JSON.stringify(me)), [me]);

            // Sync Room
            useEffect(() => {
                if (!roomId) return;
                const ref = db.ref(`rooms/${roomId}`);
                ref.on('value', snap => {
                    const val = snap.val();
                    if (val) {
                        setRoomState(val);
                        // Auto-update local bid to match current bid + 1
                        if (val.currentBid && val.phase === 'PLAYING' && val.turnIndex !== undefined && val.playerSequence[val.turnIndex] === me.id) {
                            setBid(val.currentBid); 
                        }
                        // Confetti on win
                        if (val.phase === 'REVEALED' && !roomState?.phase?.includes('REVEALED')) {
                            const outcome = val.lastResult;
                            if (outcome && outcome.winner === me.id) confetti();
                            Sounds.reveal();
                        }
                    }
                });
                return () => ref.off();
            }, [roomId]);

            // Actions
            const updateMe = (updates) => {
                const newMe = { ...me, ...updates };
                setMe(newMe);
                if (roomId) db.ref(`rooms/${roomId}/players/${me.id}`).update(updates);
            };

            const join = () => {
                const code = roomId || Math.floor(1000 + Math.random()*9000).toString();
                setRoomId(code);
                db.ref(`rooms/${code}`).transaction(room => {
                    if (!room) room = { phase: 'LOBBY', players: {}, playerSequence: [], history: [] };
                    if (!room.players[me.id]) {
                        // Late join logic: take min dice
                        const minDice = Object.values(room.players).length ? Math.min(...Object.values(room.players).map(p=>p.diceCount)) : 5;
                        room.players[me.id] = { ...me, diceCount: minDice, dice: [] };
                        room.playerSequence.push(me.id);
                    }
                    return room;
                });
            };

            const startGame = () => {
                const players = roomState.players;
                Object.keys(players).forEach(id => players[id].dice = Array.from({length: players[id].diceCount}, () => Math.ceil(Math.random()*6)));
                db.ref(`rooms/${roomId}`).update({
                    phase: 'PLAYING', players, currentBid: null, turnIndex: 0, lastResult: null
                });
            };

            const submitBid = () => {
                // Validate: Must be higher quantity OR same quantity higher value
                const curr = roomState.currentBid;
                if (curr) {
                    if (bid.q < curr.q || (bid.q === curr.q && bid.v <= curr.v)) {
                        Sounds.error();
                        // Shake button visual
                        return;
                    }
                }
                const nextTurn = (roomState.turnIndex + 1) % roomState.playerSequence.length;
                db.ref(`rooms/${roomId}`).update({
                    currentBid: bid, turnIndex: nextTurn, lastAction: { type: 'BID', player: me.id }
                });
                Sounds.click();
            };

            const callLiar = () => {
                const curr = roomState.currentBid;
                if (!curr) return;
                
                // Calculate
                const allDice = Object.values(roomState.players).flatMap(p => p.dice);
                // Wildcard: 1s count unless bid is 1s
                const count = allDice.filter(d => d === curr.v || (curr.v !== 1 && d === 1)).length;
                const liarCaught = count < curr.q;
                
                const loserId = liarCaught ? curr.player : me.id;
                const winnerId = liarCaught ? me.id : curr.player;

                const updates = { ...roomState.players };
                updates[loserId].diceCount--;
                
                db.ref(`rooms/${roomId}`).update({
                    phase: 'REVEALED',
                    players: updates,
                    lastResult: { 
                        caller: me.id, 
                        bidder: curr.player, 
                        winner: winnerId, 
                        loser: loserId,
                        bid: curr,
                        actual: count
                    }
                });
                Sounds.reveal();
            };

            const nextRound = () => {
                const activeIds = roomState.playerSequence.filter(id => roomState.players[id].diceCount > 0);
                if (activeIds.length < 2) {
                     // Game Over
                     return;
                }
                
                const updates = { ...roomState.players };
                Object.keys(updates).forEach(id => {
                    if (updates[id].diceCount > 0) 
                        updates[id].dice = Array.from({length: updates[id].diceCount}, () => Math.ceil(Math.random()*6));
                    else 
                        updates[id].dice = [];
                });

                // Loser starts? Or Winner? Let's just rotate
                const nextTurn = (roomState.turnIndex + 1) % activeIds.length;

                db.ref(`rooms/${roomId}`).update({
                    phase: 'PLAYING',
                    players: updates,
                    playerSequence: activeIds,
                    turnIndex: 0, 
                    currentBid: null,
                    lastResult: null
                });
            };

            // --- RENDER ---
            if (!roomState) return React.createElement('div', { className: 'h-screen flex flex-col items-center justify-center space-y-4' },
                React.createElement('div', { className: 'text-6xl animate-bounce' }, 'ðŸŽ²'),
                React.createElement('button', { onClick: join, className: 'bg-green-600 p-4 rounded-xl font-bold text-2xl' }, roomId ? 'JOIN GAME' : 'NEW GAME')
            );

            const myData = roomState.players[me.id];
            const isMyTurn = roomState.phase === 'PLAYING' && roomState.playerSequence[roomState.turnIndex] === me.id;
            const totalDiceStart = Object.keys(roomState.players).length * 5;
            const currentTotalDice = Object.values(roomState.players).reduce((acc, p) => acc + p.diceCount, 0);
            const deadDiceCount = totalDiceStart - currentTotalDice;

            // Editing Overlay
            if (editing) return React.createElement('div', { className: 'fixed inset-0 bg-black/90 z-50 flex flex-col items-center justify-center gap-6' },
                React.createElement('h2', { className: 'text-2xl text-yellow-400' }, 'EDIT PROFILE'),
                React.createElement('input', { value: me.name, onChange: e => updateMe({name: e.target.value}), className: 'bg-gray-800 p-3 text-center rounded text-xl' }),
                React.createElement('div', { className: 'flex flex-wrap gap-2 justify-center max-w-xs' }, 
                    ['ðŸ˜Ž','ðŸ¤ ','ðŸ¤¡','ðŸ‘»','ðŸ¤–','ðŸ‘½','ðŸŽƒ','ðŸ¦Š'].map(ic => 
                        React.createElement('button', { key: ic, onClick: () => updateMe({icon: ic}), className: `text-3xl p-2 rounded ${me.icon===ic?'bg-green-600':''}` }, ic)
                    )
                ),
                React.createElement('button', { onClick: () => setEditing(false), className: 'text-4xl' }, 'âœ…')
            );

            return React.createElement('div', { className: 'h-screen flex flex-col p-2 max-w-md mx-auto relative' },
                
                // 1. TOP: Opponents
                React.createElement('div', { className: 'flex justify-center gap-2 mb-4' },
                    roomState.playerSequence.filter(id => id !== me.id).map(id => {
                        const p = roomState.players[id];
                        const res = roomState.lastResult;
                        let state = '';
                        if (roomState.phase === 'REVEALED' && res) {
                            if (res.winner === id) state = 'win';
                            if (res.loser === id) state = 'lose';
                        }
                        return React.createElement(Avatar, { 
                            key: id, 
                            icon: p.icon, 
                            name: p.name, 
                            diceCount: p.diceCount, 
                            isActive: roomState.phase === 'PLAYING' && roomState.playerSequence[roomState.turnIndex] === id,
                            state: state
                        });
                    })
                ),

                // 2. CENTER: Table / Action / Graveyard
                React.createElement('div', { className: 'flex-1 flex flex-col items-center justify-center relative' },
                    
                    // Graveyard (Dead Dice)
                    React.createElement('div', { className: 'absolute top-0 right-0 opacity-50 flex flex-col items-center' },
                        React.createElement('span', { className: 'text-xs uppercase tracking-widest' }, 'Lost Dice'),
                        React.createElement('div', { className: 'flex items-center text-gray-500' },
                            React.createElement('span', { className: 'text-2xl font-bold mr-1' }, deadDiceCount),
                            React.createElement('span', { className: 'text-xl' }, 'ðŸ’€')
                        )
                    ),

                    // Lobby Phase
                    roomState.phase === 'LOBBY' && React.createElement('div', { className: 'text-center' },
                        React.createElement('div', { className: 'text-4xl mb-4 animate-pulse' }, 'â³'),
                        React.createElement('button', { onClick: startGame, className: 'bg-green-600 w-20 h-20 rounded-full text-4xl shadow-lg' }, 'â–¶')
                    ),

                    // Playing Phase: Current Bid
                    roomState.phase === 'PLAYING' && roomState.currentBid && React.createElement('div', { className: 'flex items-center gap-4 bg-gray-800/80 p-6 rounded-2xl border border-gray-600' },
                        React.createElement('span', { className: 'text-6xl font-black text-yellow-400' }, roomState.currentBid.q),
                        React.createElement('span', { className: 'text-2xl text-gray-400' }, 'x'),
                        React.createElement(Dice, { val: roomState.currentBid.v, size: 60 })
                    ),

                    // Revealed Phase: Results
                    roomState.phase === 'REVEALED' && React.createElement('div', { className: 'w-full grid grid-cols-3 gap-2 overflow-y-auto max-h-64 p-2 bg-black/40 rounded-xl' },
                        Object.values(roomState.players).map(p => 
                            p.dice.map((d, i) => {
                                const isRelevant = roomState.lastResult.bid.v === d || d === 1;
                                return React.createElement('div', { key: p.id+i, className: 'flex justify-center' },
                                    React.createElement(Dice, { val: d, size: 30, highlight: isRelevant })
                                );
                            })
                        )
                    ),

                    // Next Round Button (Manual)
                    roomState.phase === 'REVEALED' && React.createElement('button', { 
                        onClick: nextRound, 
                        className: 'absolute bottom-10 z-50 bg-green-500 text-black w-16 h-16 rounded-full text-3xl shadow-[0_0_20px_white] animate-bounce flex items-center justify-center' 
                    }, 'â–¶')
                ),

                // 3. BOTTOM: My Area (Stacked)
                React.createElement('div', { className: 'mt-auto flex flex-col gap-2' },
                    
                    // A. My Avatar & Edit (Floating small)
                    React.createElement('div', { 
                        onClick: () => setEditing(true),
                        className: `self-center flex items-center gap-2 bg-gray-800 px-3 py-1 rounded-full text-sm cursor-pointer border border-gray-600 ${roomState.lastResult?.loser === me.id && roomState.phase === 'REVEALED' ? 'loser-anim bg-red-900' : ''} ${roomState.lastResult?.winner === me.id && roomState.phase === 'REVEALED' ? 'winner-anim bg-green-900' : ''}` 
                    },
                        React.createElement('span', null, me.icon),
                        React.createElement('span', { className: 'font-bold' }, me.name),
                        React.createElement('span', { className: 'text-gray-400 text-xs' }, 'âœï¸')
                    ),

                    // B. My Dice (Always Visible Row)
                    myData?.diceCount > 0 && React.createElement('div', { className: 'glass p-3 rounded-xl flex justify-center gap-3 min-h-[60px]' },
                        cupOpen 
                        ? myData.dice.map((d, i) => React.createElement(Dice, { key: i, val: d, size: 45 })) 
                        : React.createElement('span', { className: 'text-4xl cursor-pointer', onClick: ()=>setCupOpen(true) }, 'ðŸ”’')
                    ),

                    // C. Controls (Only when my turn)
                    isMyTurn && React.createElement('div', { className: 'bg-gray-900 p-3 rounded-t-3xl border-t border-yellow-500 flex flex-col gap-3' },
                        // Bid Selectors
                        React.createElement('div', { className: 'flex justify-between items-center px-2' },
                            // Quantity
                            React.createElement('div', { className: 'flex items-center gap-2 bg-gray-800 rounded-lg p-1' },
                                React.createElement('button', { onClick: () => setBid(b=>({...b, q: Math.max(1, b.q-1)})), className: 'w-10 h-10 bg-gray-700 rounded text-xl' }, '-'),
                                React.createElement('span', { className: 'text-3xl font-bold w-8 text-center' }, bid.q),
                                React.createElement('button', { onClick: () => setBid(b=>({...b, q: b.q+1})), className: 'w-10 h-10 bg-gray-700 rounded text-xl' }, '+')
                            ),
                            // Value
                            React.createElement('div', { className: 'flex items-center gap-2 bg-gray-800 rounded-lg p-1' },
                                React.createElement('button', { onClick: () => setBid(b=>({...b, v: b.v===1?6:b.v-1})), className: 'w-10 h-10 bg-gray-700 rounded text-xl' }, '<'),
                                React.createElement(Dice, { val: bid.v, size: 35 }),
                                React.createElement('button', { onClick: () => setBid(b=>({...b, v: b.v===6?1:b.v+1})), className: 'w-10 h-10 bg-gray-700 rounded text-xl' }, '>')
                            )
                        ),
                        // Action Buttons
                        React.createElement('div', { className: 'flex gap-3 h-16' },
                            // Dudo / Liar
                            roomState.currentBid && React.createElement('button', { 
                                onClick: callLiar, 
                                className: 'flex-1 bg-red-600 rounded-xl text-3xl font-black shadow-lg active:scale-95 transition-transform' 
                            }, '?!'),
                            // Bet
                            React.createElement('button', { 
                                onClick: submitBid, 
                                className: 'flex-[2] bg-green-600 rounded-xl text-4xl font-black shadow-lg active:scale-95 transition-transform' 
                            }, 'âœ“')
                        )
                    )
                )
            );
        };

        ReactDOM.render(React.createElement(App), document.getElementById('root'));
    </script>
</body>
</html>
