<!DOCTYPE html>
<html lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LADODO CASINO ROYAL</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Goldman:wght@400;700&display=swap');
        
        body { 
            background: radial-gradient(circle at center, #065f46 0%, #064e3b 40%, #022c22 100%);
            color: white; user-select: none; font-family: 'Goldman', cursive; 
            overflow: hidden; touch-action: manipulation;
        }

        .casino-felt {
            background-image: radial-gradient(circle, rgba(255,255,255,0.05) 1px, transparent 1px);
            background-size: 30px 30px;
        }

        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            10% { transform: translate(-1px, -2px) rotate(-1deg); }
            20% { transform: translate(-3px, 0px) rotate(1deg); }
            30% { transform: translate(3px, 2px) rotate(0deg); }
            40% { transform: translate(1px, -1px) rotate(1deg); }
            50% { transform: translate(-1px, 2px) rotate(-1deg); }
            100% { transform: translate(1px, 1px) rotate(0deg); }
        }
        .shake-cup { animation: shake 0.2s infinite; }

        @keyframes fly-to-pile {
            0% { transform: scale(1) translate(0,0); opacity: 1; }
            100% { transform: scale(0.5) translate(var(--tw-translate-x), var(--tw-translate-y)); opacity: 0.5; }
        }
        .flying-die { animation: fly-to-pile 1s forwards ease-in; }

        .gold-glow { box-shadow: 0 0 20px rgba(234, 179, 8, 0.4); border: 2px solid #eab308; }
        .green-glow { box-shadow: 0 0 25px rgba(34, 197, 94, 0.8); border: 3px solid #22c55e; }
        
        .dice-card { background: linear-gradient(135deg, #ffffff 0%, #e2e8f0 100%); }
    </style>
</head>
<body class="casino-felt">
    <div id="root"></div>

    <script>
        // --- AUDIO ENGINE ---
        const playSound = (type) => {
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.connect(gain); gain.connect(ctx.destination);
            const now = ctx.currentTime;

            if (type === 'shake') {
                osc.type = 'square'; osc.frequency.setValueAtTime(100, now);
                osc.frequency.exponentialRampToValueAtTime(50, now + 0.1);
                gain.gain.setValueAtTime(0.05, now);
                osc.start(); osc.stop(now + 0.1);
            } else if (type === 'win') {
                [440, 554, 659].forEach((f, i) => {
                    const o = ctx.createOscillator();
                    o.connect(gain); o.frequency.setValueAtTime(f, now + i*0.1);
                    o.start(now + i*0.1); o.stop(now + 0.5);
                });
                gain.gain.setValueAtTime(0.1, now);
            } else if (type === 'lose') {
                osc.frequency.setValueAtTime(200, now);
                osc.frequency.linearRampToValueAtTime(50, now + 0.5);
                gain.gain.setValueAtTime(0.1, now);
                osc.start(); osc.stop(now + 0.5);
            }
        };

        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyCUvDUDrj1MofAFRYeDrGP7OoIz0qX0iW8",
            authDomain: "dudogame-44b81.firebaseapp.com",
            databaseURL: "https://dudogame-44b81-default-rtdb.europe-west1.firebasedatabase.app/",
            projectId: "dudogame-44b81",
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        const { useState, useEffect, useMemo, useRef } = React;
        const AVATARS = ['üé©', 'üíé', 'üí∞', 'üé∞', 'ü¶Å', 'üëë', 'üÉè', 'üç∑', 'üíµ', 'üé≤'];

        const DiceIcon = ({ value, size = 40, highlight = false, className = "" }) => {
            const dots = {
                1: [[50, 50]], 2: [[25, 25], [75, 75]], 3: [[25, 25], [50, 50], [75, 75]],
                4: [[25, 25], [25, 75], [75, 25], [75, 75]], 
                5: [[25, 25], [25, 75], [50, 50], [75, 25], [75, 75]],
                6: [[25, 25], [25, 50], [25, 75], [75, 25], [75, 50], [75, 75]]
            };
            return React.createElement('svg', { 
                width: size, height: size, viewBox: '0 0 100 100', 
                className: `dice-shadow transition-all ${highlight ? 'green-glow scale-125 animate-pulse' : ''} ${className}` 
            },
                React.createElement('rect', { x: 5, y: 5, width: 90, height: 90, rx: 18, fill: value === 1 ? '#dc2626' : 'white' }),
                dots[value]?.map(([cx, cy], i) => React.createElement('circle', { key: i, cx, cy, r: 8, fill: value === 1 ? 'white' : 'black' }))
            );
        };

        const App = () => {
            const [player, setPlayer] = useState(() => {
                const saved = JSON.parse(sessionStorage.getItem('ladodo_v3') || '{}');
                return {
                    id: saved.id || Math.random().toString(36).substring(2, 9),
                    name: saved.name || 'GUEST',
                    avatar: saved.avatar || AVATARS[0]
                };
            });
            const [gameState, setGameState] = useState(null);
            const [roomId, setRoomId] = useState('');
            const [localBid, setLocalBid] = useState({ quantity: 1, value: 2 });
            const [isEditMode, setIsEditMode] = useState(false);
            const [isShaking, setIsShaking] = useState(false);

            useEffect(() => {
                sessionStorage.setItem('ladodo_v3', JSON.stringify(player));
                const code = new URLSearchParams(window.location.search).get('room');
                if (code) { setRoomId(code); joinRoom(code); }
            }, []);

            useEffect(() => {
                if (!roomId) return;
                const roomRef = db.ref(`rooms/${roomId}`);
                roomRef.on('value', (snap) => {
                    const val = snap.val();
                    if (val) {
                        if (val.phase === 'REVEALED' && gameState?.phase !== 'REVEALED') {
                            val.lastAction?.success ? playSound('win') : playSound('lose');
                            if (val.lastAction?.success) confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 }, colors: ['#fbbf24', '#ffffff'] });
                        }
                        setGameState(val);
                        if (val.currentBid) setLocalBid(val.currentBid);
                    }
                });
                return () => roomRef.off();
            }, [roomId, gameState?.phase]);

            const createRoom = () => {
                const code = Math.floor(1000 + Math.random() * 9000).toString();
                db.ref(`rooms/${code}`).set({
                    roomId: code, hostId: player.id, phase: 'LOBBY', turnIndex: 0,
                    playerSequence: [player.id], players: { [player.id]: { ...player, diceCount: 5, dice: [] } }
                });
                setRoomId(code);
            };

            const joinRoom = (code = roomId) => {
                db.ref(`rooms/${code}`).transaction((room) => {
                    if (room) {
                        if (!room.players[player.id]) {
                            let startDice = 5;
                            if (room.phase !== 'LOBBY') {
                                const counts = Object.values(room.players).map(p => p.diceCount).filter(c => c > 0);
                                startDice = counts.length > 0 ? Math.min(...counts) : 5;
                            }
                            room.players[player.id] = { ...player, diceCount: startDice, dice: [] };
                            room.playerSequence.push(player.id);
                        }
                    }
                    return room;
                });
                setRoomId(code);
            };

            const startRound = () => {
                setIsShaking(true);
                playSound('shake');
                setTimeout(() => {
                    const newPlayers = { ...gameState.players };
                    gameState.playerSequence.forEach(pid => {
                        if (newPlayers[pid].diceCount > 0) {
                            newPlayers[pid].dice = Array.from({ length: newPlayers[pid].diceCount }, () => Math.floor(Math.random() * 6) + 1);
                        }
                    });
                    db.ref(`rooms/${roomId}`).update({
                        phase: 'PLAYING', players: newPlayers, currentBid: null, lastAction: null
                    });
                    setIsShaking(false);
                }, 1000);
            };

            const placeBid = () => {
                const nextTurn = (gameState.turnIndex + 1) % gameState.playerSequence.length;
                db.ref(`rooms/${roomId}`).update({
                    currentBid: { ...localBid, playerId: player.id },
                    turnIndex: nextTurn, lastAction: { type: 'BID', playerId: player.id }
                });
            };

            const callDudo = () => {
                const bid = gameState.currentBid;
                const allDice = Object.values(gameState.players).flatMap(p => p.dice);
                const count = allDice.filter(d => d === bid.value || (bid.value !== 1 && d === 1)).length;
                const success = count < bid.quantity;
                const loserId = success ? bid.playerId : player.id;
                
                const newPlayers = { ...gameState.players };
                newPlayers[loserId].diceCount = Math.max(0, newPlayers[loserId].diceCount - 1);

                db.ref(`rooms/${roomId}`).update({
                    phase: 'REVEALED', players: newPlayers,
                    lastAction: { success, loserId, winnerId: success ? player.id : bid.playerId, actualCount: count, bidWas: bid }
                });
            };

            const shareGame = () => {
                const url = window.location.origin + window.location.pathname + '?room=' + roomId;
                navigator.clipboard.writeText(url);
                alert('COPIED! üé≤');
            };

            const lostDiceTotal = useMemo(() => {
                if (!gameState) return 0;
                return (gameState.playerSequence.length * 5) - Object.values(gameState.players).reduce((acc, p) => acc + p.diceCount, 0);
            }, [gameState]);

            if (!gameState) return (
                <div className="h-screen flex flex-col items-center justify-center space-y-8 bg-[#022c22]">
                    <div className="text-8xl animate-bounce">üé∞</div>
                    <button onClick={createRoom} className="w-64 bg-yellow-500 hover:bg-yellow-400 text-black font-bold py-6 rounded-2xl text-3xl shadow-[0_10px_0_#b45309]">CREATE</button>
                    <div className="flex bg-white/10 p-2 rounded-2xl">
                        <input className="bg-transparent w-32 p-4 text-center text-2xl font-bold outline-none" placeholder="CODE" value={roomId} onChange={e => setRoomId(e.target.value)} />
                        <button onClick={() => joinRoom()} className="bg-green-500 px-8 rounded-xl font-bold">JOIN</button>
                    </div>
                </div>
            );

            const isMyTurn = gameState.phase === 'PLAYING' && gameState.playerSequence[gameState.turnIndex] === player.id;

            return (
                <div className="h-screen flex flex-col overflow-hidden casino-felt">
                    {/* Top Bar */}
                    <div className="p-4 flex justify-between items-center bg-black/30">
                        <button onClick={() => setIsEditMode(true)} className="text-3xl bg-yellow-500 p-2 rounded-full border-2 border-white">{player.avatar}</button>
                        <div className="flex items-center space-x-3">
                            <span className="text-yellow-500 font-bold text-xl">#{roomId}</span>
                            <button onClick={shareGame} className="bg-blue-600 p-2 rounded-lg text-xl">üì§</button>
                        </div>
                    </div>

                    {/* Opponents Circle */}
                    <div className="flex justify-center flex-wrap gap-4 p-4">
                        {gameState.playerSequence.map(pid => {
                            const p = gameState.players[pid];
                            const isTurn = gameState.phase === 'PLAYING' && gameState.playerSequence[gameState.turnIndex] === pid;
                            const isLoser = gameState.phase === 'REVEALED' && gameState.lastAction?.loserId === pid;
                            return (
                                <div key={pid} className={`flex flex-col items-center p-3 rounded-2xl transition-all ${isTurn ? 'gold-glow bg-yellow-500/20 scale-110' : 'opacity-80'}`}>
                                    <div className="text-3xl relative">
                                        {p.avatar}
                                        {isTurn && <div className="absolute -top-2 -right-2 text-xs bg-red-500 rounded-full px-1 animate-ping">‚óè</div>}
                                    </div>
                                    <div className="text-[10px] uppercase font-bold text-white/50">{p.name}</div>
                                    <div className="flex gap-0.5 mt-1">
                                        {Array.from({ length: p.diceCount }).map((_, i) => <div key={i} className="w-2 h-2 bg-yellow-500 rounded-full" />)}
                                    </div>
                                </div>
                            );
                        })}
                    </div>

                    {/* Table Center */}
                    <div className="flex-1 relative flex flex-col items-center justify-center p-6">
                        {/* Graveyard (Lost Dice Pile) */}
                        <div className="absolute top-0 flex flex-wrap max-w-[200px] justify-center gap-1 opacity-20">
                            {Array.from({ length: lostDiceTotal }).map((_, i) => <div key={i} className="w-4 h-4 bg-white rotate-12 rounded-sm" />)}
                        </div>

                        {isShaking ? (
                            <div className="text-9xl shake-cup">ü•§</div>
                        ) : gameState.phase === 'LOBBY' ? (
                            <button onClick={startRound} className="bg-green-500 w-32 h-32 rounded-full text-5xl border-8 border-green-300 shadow-2xl">‚ñ∂Ô∏è</button>
                        ) : gameState.phase === 'REVEALED' ? (
                            <div className="w-full max-w-md bg-black/40 p-6 rounded-3xl border-2 border-white/20 text-center">
                                <div className="flex flex-wrap justify-center gap-2 mb-8">
                                    {Object.values(gameState.players).flatMap(p => p.dice).map((d, i) => (
                                        <DiceIcon key={i} value={d} size={40} highlight={d === gameState.lastAction.bidWas.value || d === 1} />
                                    ))}
                                </div>
                                <div className="text-6xl font-black mb-6 text-yellow-400">
                                    {gameState.lastAction.actualCount} <span className="text-2xl">OF</span> <DiceIcon value={gameState.lastAction.bidWas.value} size={60} className="inline-block" />
                                </div>
                                <button onClick={startRound} className="bg-white text-black px-12 py-4 rounded-full text-2xl font-black shadow-xl">NEXT üîÑ</button>
                            </div>
                        ) : (
                            gameState.currentBid && (
                                <div className="flex items-center space-x-6 bg-white/5 p-10 rounded-full border-4 border-yellow-500/30">
                                    <span className="text-8xl font-black">{gameState.currentBid.quantity}</span>
                                    <span className="text-4xl text-yellow-500">‚úï</span>
                                    <DiceIcon value={gameState.currentBid.value} size={100} />
                                </div>
                            )
                        )}
                    </div>

                    {/* Player Controls */}
                    <div className="bg-black/40 p-6 rounded-t-[3rem] border-t-4 border-yellow-600/50">
                        {/* My Dice */}
                        <div className="flex justify-center gap-4 mb-6">
                            {gameState.players[player.id]?.dice?.map((d, i) => (
                                <div key={i} className="relative">
                                    <DiceIcon value={d} size={55} />
                                    {isShaking && <div className="absolute inset-0 bg-yellow-500 mix-blend-overlay animate-pulse rounded-lg"></div>}
                                </div>
                            ))}
                        </div>

                        {isMyTurn && (
                            <div className="space-y-6">
                                <div className="flex justify-around items-center">
                                    <div className="flex items-center bg-black/50 rounded-2xl p-2 border border-white/20">
                                        <button onClick={() => setLocalBid(b => ({...b, quantity: Math.max(1, b.quantity-1)}))} className="text-4xl px-4">‚ûñ</button>
                                        <span className="text-4xl font-bold w-16 text-center">{localBid.quantity}</span>
                                        <button onClick={() => setLocalBid(b => ({...b, quantity: b.quantity+1}))} className="text-4xl px-4">‚ûï</button>
                                    </div>
                                    <div className="flex items-center bg-black/50 rounded-2xl p-2 border border-white/20">
                                        <button onClick={() => setLocalBid(b => ({...b, value: b.value === 1 ? 6 : b.value-1}))} className="text-4xl px-4">‚óÄÔ∏è</button>
                                        <DiceIcon value={localBid.value} size={50} />
                                        <button onClick={() => setLocalBid(b => ({...b, value: b.value === 6 ? 1 : b.value+1}))} className="text-4xl px-4">‚ñ∂Ô∏è</button>
                                    </div>
                                </div>
                                <div className="flex gap-4">
                                    {gameState.currentBid && (
                                        <button onClick={callDudo} className="flex-1 bg-red-600 py-5 rounded-2xl text-4xl shadow-[0_8px_0_#991b1b]">ü§•</button>
                                    )}
                                    <button onClick={placeBid} className="flex-[2] bg-green-500 py-5 rounded-2xl text-4xl shadow-[0_8px_0_#166534]">üé≤</button>
                                </div>
                            </div>
                        )}
                    </div>

                    {/* Profile Editor Modal */}
                    {isEditMode && (
                        <div className="fixed inset-0 bg-black/90 z-50 flex flex-col items-center justify-center p-6">
                            <div className="text-8xl mb-8">{player.avatar}</div>
                            <input className="bg-slate-800 text-white text-3xl p-4 rounded-xl mb-8 text-center" value={player.name} onChange={e => setPlayer({...player, name: e.target.value.slice(0,8)})} />
                            <div className="grid grid-cols-5 gap-4 mb-12">
                                {AVATARS.map(a => <button key={a} onClick={() => setPlayer({...player, avatar: a})} className="text-4xl p-2">{a}</button>)}
                            </div>
                            <button onClick={() => { setIsEditMode(false); joinRoom(); }} className="bg-green-500 px-12 py-4 rounded-full text-2xl font-bold">SAVE</button>
                        </div>
                    )}
                </div>
            );
        };

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
