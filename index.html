<!DOCTYPE html>
<html lang="he">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>ðŸŽ² Dudo</title>
<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Fredoka+One&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
:root { --gold:#f5c842; --red:#e84040; --green:#2ecc71; --text:#f0ead6; }

html, body {
  width:100%; height:100%; overflow:hidden;
  font-family:'Fredoka One',cursive;
  background:#0d3318; color:var(--text);
  user-select:none; touch-action:manipulation;
  -webkit-tap-highlight-color:transparent;
}
#root {
  width:100%; height:100%; height:100dvh;
  display:flex; flex-direction:column; overflow:hidden;
  background: radial-gradient(ellipse at 50% 35%, #22723a 0%, #155227 50%, #0b2e18 100%);
}

/* Felt texture overlay */
#root::before {
  content:''; position:fixed; inset:0; pointer-events:none; z-index:0;
  background-image: repeating-linear-gradient(45deg,
    rgba(255,255,255,.012) 0px, rgba(255,255,255,.012) 1px,
    transparent 1px, transparent 12px);
}

/* â”€â”€ ANIMATIONS â”€â”€ */
@keyframes bounce-avatar {
  0%,100%{transform:translateY(0) scale(1)}
  30%{transform:translateY(-18px) scale(1.25)}
  55%{transform:translateY(-6px) scale(.95)}
  75%{transform:translateY(-3px) scale(1.05)}
}
@keyframes pulse-gold {
  0%,100%{box-shadow:0 0 0 0 rgba(245,200,66,.5)}
  50%{box-shadow:0 0 0 8px rgba(245,200,66,0)}
}
@keyframes pop-in {
  0%{transform:scale(.5);opacity:0}
  70%{transform:scale(1.1)}
  100%{transform:scale(1);opacity:1}
}
@keyframes lose-shake {
  0%,100%{transform:rotate(0)}
  20%{transform:rotate(-8deg)}
  40%{transform:rotate(8deg)}
  60%{transform:rotate(-5deg)}
  80%{transform:rotate(5deg)}
}
@keyframes reveal-in {
  0%{transform:scale(.7) translateY(20px);opacity:0}
  60%{transform:scale(1.04) translateY(-3px)}
  100%{transform:scale(1) translateY(0);opacity:1}
}
@keyframes slide-up {
  from{transform:translateY(100%);opacity:0}
  to{transform:translateY(0);opacity:1}
}
@keyframes spin { from{transform:rotate(0)} to{transform:rotate(360deg)} }
@keyframes land-pile {
  0%{transform:scale(.25) rotate(-40deg);opacity:0}
  65%{transform:scale(1.1) rotate(4deg);opacity:1}
  100%{transform:scale(1) rotate(var(--pr,0deg));opacity:1}
}
/* Cup shake for round start animation */
@keyframes cup-wiggle {
  0%,100% { transform: translateY(0) rotate(0deg); }
  15%  { transform: translateY(-8px) rotate(-5deg); }
  30%  { transform: translateY(-12px) rotate(5deg); }
  45%  { transform: translateY(-8px) rotate(-3deg); }
  60%  { transform: translateY(-10px) rotate(3deg); }
  75%  { transform: translateY(-6px) rotate(-2deg); }
  90%  { transform: translateY(-3px) rotate(2deg); }
}
@keyframes dice-tumble {
  0%   { transform: rotate(0deg) scale(1); opacity:.7; }
  25%  { transform: rotate(90deg) scale(1.1); opacity:1; }
  50%  { transform: rotate(180deg) scale(.9); opacity:.8; }
  75%  { transform: rotate(270deg) scale(1.05); opacity:1; }
  100% { transform: rotate(360deg) scale(1); opacity:.7; }
}
/* flying die: pure CSS from loser card toward bottom-right (pile is bottom-right corner) */
@keyframes fly-die {
  0%  {transform:translate(0,0) scale(1) rotate(0deg);opacity:1}
  60% {transform:translate(var(--dx),var(--dy)) scale(.6) rotate(400deg);opacity:.9}
  100%{transform:translate(var(--dx2),var(--dy2)) scale(.25) rotate(640deg);opacity:0}
}
@keyframes flash-red {
  0%,100%{background:transparent}
  25%{background:rgba(232,64,64,.22)}
}
@keyframes flash-green {
  0%,100%{background:transparent}
  25%{background:rgba(46,204,113,.18)}
}

/* â”€â”€ PLAYER CARD â”€â”€ */
.pcard {
  background:rgba(0,0,0,.3); border:2px solid rgba(255,255,255,.1);
  border-radius:14px; padding:9px 10px;
  text-align:center; transition:border-color .25s, background .25s, transform .2s;
  position:relative; overflow:hidden;
}
.pcard.active { border-color:var(--gold); background:rgba(245,200,66,.1); animation:pulse-gold 1.8s infinite; transform:scale(1.07); }
.pcard.r-won  { border-color:var(--green); background:rgba(46,204,113,.12); }
.pcard.r-lost { border-color:var(--red);   background:rgba(232,64,64,.12); animation:lose-shake .55s ease; }
.pcard.eliminated { opacity:.45; filter:grayscale(.6); }

/* â”€â”€ BUTTONS â”€â”€ */
.btn { border:none; cursor:pointer; font-family:'Fredoka One',cursive; transition:transform .1s; border-radius:14px; }
.btn:active { transform:scale(.95); }
.btn-gold {
  background:linear-gradient(160deg,#f7d060 0%,#e8a820 100%);
  color:#1a1a00; box-shadow:0 4px 12px rgba(0,0,0,.4),inset 0 1px 0 rgba(255,255,255,.3);
}
.btn-red {
  background:linear-gradient(160deg,#ff5555 0%,#c01010 100%);
  color:white; box-shadow:0 4px 12px rgba(200,0,0,.35);
}
.btn-ghost {
  background:rgba(255,255,255,.08); color:var(--text);
  border:2px solid rgba(255,255,255,.18)!important;
}

/* â”€â”€ INPUT â”€â”€ */
.casino-input {
  background:rgba(0,0,0,.35); border:2px solid rgba(245,200,66,.35);
  border-radius:12px; color:white; font-family:'Fredoka One',cursive;
  outline:none; text-align:center;
}
.casino-input:focus { border-color:var(--gold); }
.casino-input::placeholder { color:rgba(255,255,255,.3); }

/* â”€â”€ RESULT OVERLAY â”€â”€ */
.result-overlay {
  position:fixed; inset:0; background:rgba(0,0,0,.88); z-index:100;
  display:flex; flex-direction:column; align-items:center; justify-content:flex-start;
  padding:14px 14px 20px; gap:10px; overflow-y:auto;
  animation:slide-up .25s ease;
}

/* â”€â”€ CONTROLS PANEL â”€â”€ */
.ctrl {
  background:linear-gradient(0deg,rgba(5,20,10,.98) 0%,rgba(10,35,18,.95) 100%);
  border-top:1.5px solid rgba(245,200,66,.25);
  padding:11px 13px 12px; flex-shrink:0;
}

/* â”€â”€ PYRAMID PILE â”€â”€ */
.pile-wrap {
  position:absolute; bottom:8px; right:8px;
  display:flex; flex-direction:column; align-items:center;
  gap:1px; pointer-events:none;
}
.pile-row { display:flex; gap:2px; justify-content:center; }
.pile-die-item { display:inline-block; }
.pile-die-item.fresh { animation:land-pile .42s cubic-bezier(.3,.7,.4,1) both; }

/* Flying die overlay (absolute, inside result card parent) */
.flying-die {
  position:fixed; pointer-events:none; z-index:300;
  animation:fly-die .65s ease-in both;
}

::-webkit-scrollbar { display:none; }
</style>
</head>
<body>
<div id="root"></div>
<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUDIO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SFX = (() => {
  let ctx;
  const C=()=>{ if(!ctx) ctx=new(window.AudioContext||window.webkitAudioContext)(); if(ctx.state==='suspended') ctx.resume(); return ctx; };
  const tone=(type,freq,vol,dur,fe)=>{ const c=C(),o=c.createOscillator(),g=c.createGain(); o.connect(g);g.connect(c.destination); o.type=type; o.frequency.setValueAtTime(freq,c.currentTime); if(fe) o.frequency.exponentialRampToValueAtTime(fe,c.currentTime+dur); g.gain.setValueAtTime(vol,c.currentTime); g.gain.exponentialRampToValueAtTime(.001,c.currentTime+dur); o.start();o.stop(c.currentTime+dur); };
  return {
    click:()=>tone('sine',600,.07,.08,300),
    win:()=>{tone('triangle',400,.1,.5,1200);setTimeout(()=>tone('triangle',700,.07,.4,1400),200);setTimeout(()=>tone('triangle',900,.05,.35,1600),400);},
    lose:()=>{tone('sawtooth',180,.18,.45,70);setTimeout(()=>tone('sawtooth',100,.12,.3,55),320);},
    place:()=>tone('triangle',900,.05,.1,450),
    reveal:()=>{tone('square',160,.12,.6,55);setTimeout(()=>tone('sine',280,.08,.35,180),250);},
    shake:()=>{ const c=C(),sz=c.sampleRate*.3,buf=c.createBuffer(1,sz,c.sampleRate),d=buf.getChannelData(0); for(let i=0;i<sz;i++) d[i]=Math.random()*2-1; const s=c.createBufferSource(),g=c.createGain(); g.gain.setValueAtTime(.1,c.currentTime);g.gain.exponentialRampToValueAtTime(.001,c.currentTime+.3); s.buffer=buf;s.connect(g);g.connect(c.destination);s.start(); }
  };
})();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FIREBASE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
firebase.initializeApp({
  apiKey:"AIzaSyCUvDUDrj1MofAFRYeDrGP7OoIz0qX0iW8",
  authDomain:"dudogame-44b81.firebaseapp.com",
  databaseURL:"https://dudogame-44b81-default-rtdb.europe-west1.firebasedatabase.app/",
  projectId:"dudogame-44b81",
  storageBucket:"dudogame-44b81.firebasestorage.app",
  messagingSenderId:"681233339238",
  appId:"1:681233339238:web:c8ed065e83227b6bd22ea7"
});
const db = firebase.database();
const { useState, useEffect, useRef, useMemo } = React;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONSTANTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const AVATARS = ['ðŸ˜Ž','ðŸ¤ ','ðŸ‘½','ðŸ‘»','ðŸ¤–','ðŸ¦Š','ðŸ¦','ðŸ¦„','ðŸ¸','ðŸµ','ðŸ¯','ðŸ¦…','ðŸ²','ðŸ’€','ðŸŽ­','ðŸ¦–','ðŸ¦‹','ðŸ™','ðŸ¦©','ðŸº'];
const rollDice = n => Array.from({length:n}, ()=>Math.floor(Math.random()*6)+1);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DICE SVG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const DOTS = {
  1:[[50,50]], 2:[[28,28],[72,72]], 3:[[28,28],[50,50],[72,72]],
  4:[[28,28],[72,28],[28,72],[72,72]], 5:[[28,28],[72,28],[50,50],[28,72],[72,72]],
  6:[[28,28],[28,50],[28,72],[72,28],[72,50],[72,72]]
};
const DiceSVG = ({ val, size=44, bright=false, dim=false, extraStyle={} }) => {
  const ace = val===1;
  const gradId = `dg${val}${size}${bright?'b':''}`;
  const border = bright ? '#2ecc71' : (ace ? '#e84040' : 'rgba(255,255,255,.3)');
  const glow   = bright ? 'drop-shadow(0 0 6px #2ecc71)' : (ace ? 'drop-shadow(0 0 4px #e84040)' : 'drop-shadow(1px 2px 4px rgba(0,0,0,.7))');
  const c0     = bright ? '#2e7d45' : (ace ? '#900' : '#252545');
  const c1     = bright ? '#0d3318' : (ace ? '#500' : '#0d0d1a');
  return React.createElement('svg', { width:size, height:size, viewBox:'0 0 100 100',
    style:{ opacity:dim?.55:1, filter:glow, flexShrink:0, ...extraStyle } },
    React.createElement('defs', null,
      React.createElement('linearGradient', { id:gradId, x1:'0%',y1:'0%',x2:'100%',y2:'100%' },
        React.createElement('stop',{offset:'0%',stopColor:c0}),
        React.createElement('stop',{offset:'100%',stopColor:c1}))),
    React.createElement('rect',{x:5,y:5,width:90,height:90,rx:16,fill:`url(#${gradId})`,stroke:border,strokeWidth:bright?4:2}),
    (DOTS[val]||[]).map(([cx,cy],i)=>React.createElement('circle',{key:i,cx,cy,r:ace?11:7.5,fill:bright?'#a8ffcc':(ace?'#ff5555':'white')}))
  );
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PYRAMID PILE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const PyramidPile = ({ count, freshIdx }) => {
  // Build pyramid rows from bottom: 4,3,2,1 ...
  const dice = Array.from({length:Math.min(count,15)},(_,i)=>({
    v: 1+(i%6),
    r: -25+(((i*137+29)%50))
  }));
  // Build rows bottom-up: each row = prev+1 count, max 4
  const rows = [];
  let remaining = dice.length;
  let rowSize = 4;
  while(remaining > 0) {
    const n = Math.min(rowSize, remaining);
    rows.unshift(dice.slice(dice.length - remaining, dice.length - remaining + n));
    remaining -= n;
    rowSize = Math.max(1, rowSize-1);
  }

  return React.createElement('div', { className:'pile-wrap' },
    rows.map((row, ri) =>
      React.createElement('div', { key:ri, className:'pile-row' },
        row.map((d, di) => {
          const idx = dice.indexOf(d); // real index in full array
          const isFresh = idx === count-1 && freshIdx;
          return React.createElement('div', {
            key:di,
            className:`pile-die-item${isFresh?' fresh':''}`,
            style:{ transform:`rotate(${d.r}deg)`, '--pr':`${d.r}deg` }
          }, React.createElement(DiceSVG, { val:d.v, size:22, dim:true }));
        })
      )
    )
  );
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PLAYER CARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const PlayerCard = ({ p, isActive, rState, isMe, onAvatar, onName, eliminated }) => {
  const [editing, setEditing] = useState(false);
  const [tmp, setTmp] = useState(p.name);
  const save = () => { setEditing(false); const n=tmp.trim().substring(0,12); if(n&&onName) onName(n); else setTmp(p.name); };
  const cls = `pcard${isActive?' active':''}${rState==='won'?' r-won':''}${rState==='lost'?' r-lost':''}${eliminated?' eliminated':''}`;

  return React.createElement('div', { className:cls, style:{minWidth:62,maxWidth:76} },
    React.createElement('div', {
      style:{fontSize:28,lineHeight:1,cursor:isMe?'pointer':'default'},
      onClick: isMe ? onAvatar : undefined
    }, p.avatar),
    editing
      ? React.createElement('input', {
          autoFocus:true, value:tmp,
          onChange:e=>setTmp(e.target.value.substring(0,12)),
          onBlur:save,
          onKeyDown:e=>{ if(e.key==='Enter') save(); if(e.key==='Escape'){setEditing(false);setTmp(p.name);} },
          style:{background:'transparent',border:'none',borderBottom:'2px solid #f5c842',
            color:'white',fontFamily:"'Fredoka One',cursive",fontSize:'.72rem',
            textAlign:'center',outline:'none',width:62,marginTop:3}
        })
      : React.createElement('div', {
          style:{fontSize:'.72rem',marginTop:3,overflow:'hidden',textOverflow:'ellipsis',
            whiteSpace:'nowrap',maxWidth:70,margin:'3px auto 0',
            color:isMe?'#f5c842':'rgba(255,255,255,.85)',
            cursor:isMe?'pointer':'default'},
          onClick: isMe ? ()=>{setTmp(p.name);setEditing(true);} : undefined
        }, p.name)
  );
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BID DISPLAY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const BidCenter = ({ bid, players }) => {
  if (!bid) return React.createElement('div',{style:{fontSize:'.9rem',color:'rgba(255,255,255,.3)',letterSpacing:3,textAlign:'center'}},'Â· Â· Â·');
  const bidder = players?.[bid.playerId];
  return React.createElement('div',{style:{display:'flex',flexDirection:'column',alignItems:'center',gap:6,
    background:'rgba(0,0,0,.4)',border:'2px solid rgba(245,200,66,.3)',borderRadius:20,padding:'12px 22px',
    animation:'pop-in .3s ease'}},
    React.createElement('div',{style:{display:'flex',alignItems:'center',gap:12}},
      React.createElement('span',{style:{fontSize:'2.8rem',fontWeight:'bold',color:'white',textShadow:'0 0 8px rgba(245,200,66,.5)'}},bid.quantity),
      React.createElement('span',{style:{fontSize:'1.4rem',opacity:.4}},'Ã—'),
      React.createElement(DiceSVG,{val:bid.value,size:52})
    ),
    bidder && React.createElement('div',{style:{fontSize:'.75rem',color:'rgba(255,255,255,.5)',display:'flex',alignItems:'center',gap:4}},
      bidder.avatar,' ',bidder.name)
  );
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CUP SHAKE ANIMATION (round start)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const CupShakeAnim = ({ onDone }) => {
  useEffect(() => {
    const t = setTimeout(onDone, 1200);
    return () => clearTimeout(t);
  }, []);

  return React.createElement('div', {
    style:{
      position:'fixed', inset:0, zIndex:150,
      background:'rgba(0,0,0,.75)',
      display:'flex', alignItems:'center', justifyContent:'center',
      animation:'pop-in .2s ease'
    }
  },
    React.createElement('div', {
      style:{
        position:'relative', display:'flex', flexDirection:'column',
        alignItems:'center', gap:12
      }
    },
      // Cup
      React.createElement('div', {
        style:{ fontSize:'6rem', lineHeight:1, animation:'cup-wiggle .8s ease-in-out infinite' }
      }, 'ðŸ¥¤'),
      // Dice tumbling inside
      React.createElement('div', {
        style:{ display:'flex', gap:8, position:'absolute', top:'50%', left:'50%',
          transform:'translate(-50%, -50%)' }
      },
        [1,2,3].map(i => React.createElement(DiceSVG, {
          key:i, val:1+(i%6), size:28,
          extraStyle:{ animation:`dice-tumble ${.4 + i*.1}s linear infinite` }
        }))
      )
    )
  );
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FLYING DIE (DOM portal for animation)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const FlyingDie = ({ fromEl, onDone }) => {
  const ref = useRef(null);
  useEffect(() => {
    if (!ref.current || !fromEl) return;
    const fr = fromEl.getBoundingClientRect();
    // target: pile is bottom-right of screen
    const tx = window.innerWidth - fr.left - fr.width/2 - 50;
    const ty = window.innerHeight - fr.top - fr.height/2 - 50;
    ref.current.style.left = (fr.left + fr.width/2 - 18) + 'px';
    ref.current.style.top  = (fr.top  + fr.height/2 - 18) + 'px';
    ref.current.style.setProperty('--dx',  tx*0.6+'px');
    ref.current.style.setProperty('--dy',  ty*0.6+'px');
    ref.current.style.setProperty('--dx2', tx+'px');
    ref.current.style.setProperty('--dy2', ty+'px');
    const t = setTimeout(onDone, 700);
    return () => clearTimeout(t);
  }, []);
  return React.createElement('div', { ref, className:'flying-die' },
    React.createElement(DiceSVG, { val:1, size:36 })
  );
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RESULT SCREEN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const ResultScreen = ({ gs, myId, onNext }) => {
  const la = gs.lastAction;
  if (!la) return null;
  const [showFlying, setShowFlying] = useState(false);
  const [flyDone, setFlyDone] = useState(false);
  const loserCardRef = useRef(null);

  useEffect(() => { setTimeout(()=>setShowFlying(true), 400); }, []);

  const callerWon = la.success;
  const caller = gs.players[la.caller];
  const bidder = gs.players[la.bidder];
  const loser  = gs.players[la.loserId];
  const winner = callerWon ? caller : bidder;
  const bidVal = la.bidWas?.value;
  const isMe   = myId===la.caller;
  const isBidder = myId===la.bidder;
  const iLost  = myId===la.loserId;
  const iWon   = myId===winner.id;

  // Flash & confetti for winner
  useEffect(() => {
    if (iWon) {
      confetti({ particleCount:120, spread:70, origin:{y:.6}, colors:['#2ecc71','#00e676','#a8ffcc'] });
      setTimeout(()=>confetti({ particleCount:60, spread:100, origin:{x:.2,y:.4} }), 300);
      setTimeout(()=>confetti({ particleCount:60, spread:100, origin:{x:.8,y:.4} }), 500);
    }
  }, [iWon]);

  const allDice = gs.playerSequence.map(pid=>({pid,p:gs.players[pid],dice:gs.players[pid]?.dice||[]})).filter(x=>x.dice.length>0);

  // Color: green for winner, red for loser
  const borderColor = iWon ? '#2ecc71' : (iLost ? '#e84040' : (callerWon ? '#2ecc71' : '#e84040'));
  const bgColor = iWon ? 'rgba(18,70,35,.92)' : (iLost ? 'rgba(70,10,10,.92)' : (callerWon ? 'rgba(18,70,35,.92)' : 'rgba(70,10,10,.92)'));

  return React.createElement('div', { className:'result-overlay', style:{ animation: iWon ? 'flash-green .6s ease' : (iLost ? 'flash-red .6s ease' : 'none') } },
    showFlying && !flyDone && loserCardRef.current &&
      React.createElement(FlyingDie, { fromEl:loserCardRef.current, onDone:()=>setFlyDone(true) }),

    // Result card
    React.createElement('div', {
      style:{width:'100%',maxWidth:360,borderRadius:20,
        border:`3px solid ${borderColor}`,
        background:bgColor,
        padding:'13px 16px',textAlign:'center',
        boxShadow:`0 0 24px ${iWon?'rgba(46,204,113,.5)':'rgba(232,64,64,.4)'}`,
        animation:'reveal-in .4s cubic-bezier(.3,.7,.4,1) both'}},

      // Caller vs bidder
      React.createElement('div',{style:{display:'flex',alignItems:'center',justifyContent:'center',gap:14,marginBottom:10}},
        React.createElement('div',{style:{fontSize:34,animation:callerWon?'bounce-avatar .7s ease':'lose-shake .5s ease'}},caller?.avatar),
        React.createElement('span',{style:{fontSize:18,opacity:.6}},callerWon?'âœ‹':'ðŸ˜¬'),
        React.createElement('div',{style:{fontSize:34,animation:!callerWon?'bounce-avatar .7s ease':'lose-shake .5s ease'}},bidder?.avatar)
      ),

      // Emoji result â€” personalized
      React.createElement('div',{style:{fontSize:'2rem',marginBottom:8}},
        iWon ? 'ðŸŽ‰ðŸ†ðŸŽ‰' : (iLost ? 'ðŸ’€âŒðŸ’€' : (callerWon ? 'âœ…' : 'âŒ'))),

      // Clear message: who won, who lost
      React.createElement('div',{style:{fontSize:'.95rem',color:iWon?'#2ecc71':(iLost?'#e84040':'rgba(255,255,255,.7)'),marginBottom:8,fontWeight:'bold'}},
        iWon ? 'ðŸŽŠ' : (iLost ? '' : ''),
        ' ', winner?.avatar, ' ', winner?.name
      ),

      // Count vs bid
      React.createElement('div',{style:{display:'flex',alignItems:'center',justifyContent:'center',gap:10,marginBottom:6}},
        React.createElement('span',{style:{fontSize:'2rem',fontWeight:'bold',color:la.actualCount>=la.bidWas?.quantity?'#2ecc71':'#e84040'}},la.actualCount),
        React.createElement('span',{style:{opacity:.4,fontSize:'1.2rem'}},'Ã—'),
        React.createElement(DiceSVG,{val:bidVal||2,size:34}),
        React.createElement('span',{style:{opacity:.4,fontSize:'.95rem'}},' / '+la.bidWas?.quantity)
      ),

      // Who loses die
      React.createElement('div', { ref:loserCardRef,
        style:{fontSize:'.85rem',color:'#e84040',display:'flex',alignItems:'center',justifyContent:'center',gap:5,marginTop:4}},
        loser?.avatar,' ',loser?.name,' âˆ’1 ðŸŽ²')
    ),

    // All dice
    React.createElement('div',{style:{width:'100%',maxWidth:360}},
      allDice.map(({pid,p,dice})=>
        React.createElement('div',{key:pid,style:{display:'flex',alignItems:'center',gap:6,marginBottom:7,
          background:'rgba(255,255,255,.05)',borderRadius:11,padding:'6px 9px'}},
          React.createElement('span',{style:{fontSize:20,flexShrink:0}},p.avatar),
          React.createElement('div',{style:{display:'flex',gap:3,flexWrap:'wrap',alignItems:'center'}},
            dice.map((d,i)=>{const m=d===bidVal||(bidVal!==1&&d===1); return React.createElement(DiceSVG,{key:i,val:d,size:32,bright:m,dim:!m});})
          ),
          pid===la.loserId&&React.createElement('span',{style:{fontSize:13,color:'#e84040',flexShrink:0,marginLeft:'auto'}},'âˆ’1')
        )
      )
    ),

    // Next round â€” any player
    React.createElement('button',{className:'btn btn-gold',
      style:{width:'100%',maxWidth:360,padding:'14px 0',fontSize:'1.25rem'},
      onClick:onNext},'â–¶')
  );
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PUBLIC ROOMS LIST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const PublicRoomsList = ({ myId, onJoin }) => {
  const [rooms, setRooms] = useState([]);
  useEffect(() => {
    const ref = db.ref('publicRooms');
    ref.on('value', snap => {
      const val = snap.val() || {};
      // Filter: must have players, not WON or DONE
      const list = Object.values(val).filter(r => {
        if (!r || r.phase === 'DONE' || r.phase === 'WON') return false;
        const playerCount = Object.keys(r.players || {}).length;
        return playerCount > 0;
      });
      setRooms(list);
    });
    return () => ref.off();
  }, []);

  if (!rooms.length) return React.createElement('div',{style:{fontSize:'.8rem',color:'rgba(255,255,255,.3)',textAlign:'center',marginTop:4}},'â€”');

  return React.createElement('div',{style:{width:'100%',maxWidth:300,display:'flex',flexDirection:'column',gap:6}},
    rooms.map(r => React.createElement('div',{key:r.roomId,
      style:{display:'flex',justifyContent:'space-between',alignItems:'center',
        background:'rgba(0,0,0,.35)',borderRadius:12,padding:'8px 12px',
        border:'1.5px solid rgba(245,200,66,.2)'}},
      React.createElement('div',{style:{display:'flex',alignItems:'center',gap:8}},
        React.createElement('span',{style:{fontSize:'1.1rem',letterSpacing:3,fontFamily:'monospace',color:'#f5c842'}},r.roomId),
        React.createElement('span',{style:{fontSize:'.75rem',color:'rgba(255,255,255,.45)'}},
          Object.keys(r.players||{}).length + ' ðŸŽ®')
      ),
      React.createElement('button',{className:'btn btn-gold',
        style:{padding:'5px 14px',fontSize:'.85rem',borderRadius:10},
        onClick:()=>onJoin(r.roomId)},'â–¶')
    ))
  );
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MAIN APP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const App = () => {
  const [player, setPlayer] = useState(() => {
    const s = JSON.parse(sessionStorage.getItem('dudo_p')||'{}');
    return { id:s.id||Math.random().toString(36).substring(2,9), name:s.name||'Player', avatar:s.avatar||AVATARS[Math.floor(Math.random()*AVATARS.length)] };
  });
  const [gs, setGs]               = useState(null);
  const [roomId, setRoomId]       = useState('');
  const [roomInput, setRoomInput] = useState('');
  const [bid, setBid]             = useState({qty:1,val:2});
  const [showResult, setShowResult] = useState(false);
  const [copied, setCopied]       = useState(false);
  const [pileFlash, setPileFlash] = useState(false);
  const [notif, setNotif]         = useState(null);
  const [isPublic, setIsPublic]   = useState(false); // lobby choice
  const [cupShaking, setCupShaking] = useState(false); // round start anim
  const prevPhase = useRef(null);
  const prevPile  = useRef(0);

  // Persist + presence tracking
  useEffect(() => {
    sessionStorage.setItem('dudo_p', JSON.stringify(player));
    if (roomId) {
      db.ref(`rooms/${roomId}/players/${player.id}/name`).set(player.name);
      db.ref(`rooms/${roomId}/players/${player.id}/avatar`).set(player.avatar);
      // Set presence marker
      const presenceRef = db.ref(`rooms/${roomId}/players/${player.id}/online`);
      presenceRef.set(true);
      presenceRef.onDisconnect().remove();
      
      // If public, sync to publicRooms and cleanup on disconnect
      if (gs?.isPublic) {
        db.ref(`publicRooms/${roomId}/players/${player.id}`).set({avatar:player.avatar,name:player.name});
        db.ref(`publicRooms/${roomId}/players/${player.id}`).onDisconnect().remove();
        // Also remove entire public room if this was last player
        db.ref(`publicRooms/${roomId}`).onDisconnect().remove();
      }
    }
  }, [player, roomId, gs?.isPublic]);

  // Auto-join from URL
  useEffect(() => {
    const code = new URLSearchParams(window.location.search).get('room');
    if (code && code.length===4) { setRoomInput(code); doJoin(code); }
  }, []);

  // Firebase listener
  useEffect(() => {
    if (!roomId) return;
    const ref = db.ref(`rooms/${roomId}`);
    ref.on('value', snap => {
      const val = snap.val();
      if (!val) return;
      const prev = prevPhase.current;
      if (val.phase==='REVEALED' && prev!=='REVEALED') { SFX.reveal(); setShowResult(true); }
      if (val.phase==='PLAYING' && prev==='REVEALED') {
        setShowResult(false);
        setCupShaking(true); // Show cup shake
        SFX.shake();
        const np = val.tableDice||0;
        if (np > (prevPile.current||0)) { setPileFlash(true); setTimeout(()=>setPileFlash(false),900); }
        prevPile.current = np;
        // Reset bid to 1Ã—2 when new round starts
        setBid({qty:1,val:2});
      }
      // Also trigger cup shake when starting first round from LOBBY
      if (val.phase==='PLAYING' && prev==='LOBBY') {
        setCupShaking(true);
        SFX.shake();
      }
      if (val.phase==='PLAYING' && prev==='PLAYING' && val.currentBid) {
        // When a bid is placed, update local bid to match current board bid
        setBid({qty:val.currentBid.quantity, val:val.currentBid.value});
      }
      if (val.phase==='WON' && prev!=='WON') {
        SFX.win();
        confetti({particleCount:180,spread:80,origin:{y:.5},colors:['#f5c842','#2ecc71','#ff6b6b']});
        setTimeout(()=>confetti({particleCount:80,spread:120,origin:{x:.1,y:.3}}),500);
        setTimeout(()=>confetti({particleCount:80,spread:120,origin:{x:.9,y:.3}}),700);
      }
      prevPhase.current = val.phase;
      setGs(val);
    });
    return () => ref.off();
  }, [roomId]);

  // â”€â”€ helpers â”€â”€
  const notify = msg => { setNotif(msg); setTimeout(()=>setNotif(null),1800); };

  // pick an avatar that's not taken by anyone already in room
  const pickFreshAvatar = (takenAvatars=[]) => {
    const available = AVATARS.filter(a => !takenAvatars.includes(a));
    if (available.length) return available[Math.floor(Math.random()*available.length)];
    return AVATARS[Math.floor(Math.random()*AVATARS.length)];
  };

  const nextAvatar = () => {
    if (!gs) { const i=AVATARS.indexOf(player.avatar); setPlayer(p=>({...p,avatar:AVATARS[(i+1)%AVATARS.length]})); return; }
    const taken = Object.values(gs.players||{}).map(p=>p.avatar).filter(a=>a!==player.avatar);
    const avail = AVATARS.filter(a=>!taken.includes(a));
    const cur = avail.indexOf(player.avatar);
    const next = avail[(cur+1)%avail.length] || player.avatar;
    setPlayer(p=>({...p,avatar:next}));
  };

  // â”€â”€ room actions â”€â”€
  const doCreate = (pub) => {
    const code = Math.floor(1000+Math.random()*9000).toString();
    const init = {
      roomId:code, hostId:player.id, phase:'LOBBY',
      turnIndex:0, playerSequence:[player.id], tableDice:0,
      isPublic:pub,
      players:{[player.id]:{...player,diceCount:5,dice:[]}}
    };
    db.ref(`rooms/${code}`).set(init);
    if (pub) db.ref(`publicRooms/${code}`).set({roomId:code,phase:'LOBBY',players:init.players});
    setRoomId(code); setGs(init); SFX.click();
    window.history.pushState({},'',`?room=${code}`);
  };

  const doJoin = code => {
    const c=(code||roomInput||'').toString().trim().toUpperCase();
    if (!c||c.length!==4) return;
    db.ref(`rooms/${c}`).transaction(room=>{
      if (!room) return room;
      const taken = Object.values(room.players||{}).map(p=>p.avatar);
      let myAvatar = player.avatar;
      if (taken.includes(myAvatar)) myAvatar = pickFreshAvatar(taken);
      if (!room.players[player.id]) {
        const vals=Object.values(room.players);
        const minDice=room.phase==='PLAYING'?Math.min(...vals.map(p=>p.diceCount)):5;
        room.players[player.id]={...player,avatar:myAvatar,diceCount:minDice,dice:[]};
        room.playerSequence=room.playerSequence||[];
        if(!room.playerSequence.includes(player.id)) room.playerSequence.push(player.id);
      }
      return room;
    },(err,committed,snap)=>{
      const val=snap&&snap.val();
      if (val) {
        setRoomId(c); setGs(val); SFX.click();
        window.history.pushState({},'',`?room=${c}`);
      } else { notify('âŒ'); }
    });
  };

  // Ensure avatar is unique on room entry
  const ensureUniqueAvatar = () => {
    if (!gs) return;
    const taken = Object.values(gs.players||{}).map(p=>p.id!==player.id&&p.avatar).filter(Boolean);
    if (taken.includes(player.avatar)) {
      const fresh = pickFreshAvatar(taken);
      setPlayer(p=>({...p,avatar:fresh}));
    }
  };
  useEffect(ensureUniqueAvatar, [gs?.roomId]);

  const doStartGame = () => {
    const np = {...gs.players};
    Object.keys(np).forEach(pid=>{ if(np[pid].diceCount>0) np[pid].dice=rollDice(np[pid].diceCount); });
    db.ref(`rooms/${roomId}`).update({phase:'PLAYING',players:np,currentBid:null,turnIndex:0,lastAction:null,tableDice:0});
    if (gs.isPublic) db.ref(`publicRooms/${roomId}/phase`).set('PLAYING');
    SFX.shake();
  };

  // next round: loser's next player starts
  const doNextRound = () => {
    if (!gs) return;
    const la = gs.lastAction;
    const np = {...gs.players};
    const alive = gs.playerSequence.filter(pid=>(np[pid]?.diceCount||0)>0);
    if (alive.length===1) {
      db.ref(`rooms/${roomId}`).update({phase:'WON',winnerId:alive[0]});
      if (gs.isPublic) db.ref(`publicRooms/${roomId}/phase`).set('WON');
      return;
    }
    const newPile = (gs.tableDice||0)+1;
    alive.forEach(pid=>{ np[pid].dice=rollDice(np[pid].diceCount); });
    // start turn: player after the loser in alive list
    const loserIdx = alive.indexOf(la?.loserId);
    const nextStart = loserIdx>=0 ? (loserIdx+1)%alive.length : 0;
    db.ref(`rooms/${roomId}`).update({
      phase:'PLAYING', players:np, playerSequence:alive,
      turnIndex:nextStart, currentBid:null, lastAction:null, tableDice:newPile
    });
    if (gs.isPublic) db.ref(`publicRooms/${roomId}`).update({phase:'PLAYING',players:np});
  };

  // restart â€” any player can trigger
  const doRestart = () => {
    const np = {...gs.players};
    // restore all players to 5 dice
    Object.keys(np).forEach(pid=>{ np[pid].diceCount=5; np[pid].dice=rollDice(5); });
    const seq = Object.keys(np);
    db.ref(`rooms/${roomId}`).update({
      phase:'PLAYING', players:np, playerSequence:seq,
      turnIndex:0, currentBid:null, lastAction:null, tableDice:0, winnerId:null
    });
    if (gs.isPublic) db.ref(`publicRooms/${roomId}`).update({phase:'PLAYING',players:np});
    SFX.shake();
  };

  const doPlaceBid = () => {
    const cur = gs.currentBid;
    const totalDice = Object.values(gs.players).reduce((s,p)=>(p.diceCount||0)+s, 0);
    if (bid.qty > totalDice) { notify('â¬†ï¸'); return; }
    if (cur) {
      const ok = bid.qty>cur.quantity || (bid.qty===cur.quantity&&bid.val>cur.value);
      if (!ok) { SFX.lose(); notify('â¬†ï¸'); return; }
    }
    // skip eliminated players in turn rotation
    let next = gs.turnIndex;
    const seq = gs.playerSequence;
    do { next=(next+1)%seq.length; } while((gs.players[seq[next]]?.diceCount||0)===0 && next!==gs.turnIndex);
    db.ref(`rooms/${roomId}`).update({ currentBid:{quantity:bid.qty,value:bid.val,playerId:player.id}, turnIndex:next });
    SFX.place();
  };

  const doCallDudo = () => {
    const cb = gs.currentBid;
    const allDice = Object.values(gs.players).flatMap(p=>p.dice||[]);
    const count = allDice.filter(d=>d===cb.value||(cb.value!==1&&d===1)).length;
    const callerWon = count<cb.quantity;
    const loserId = callerWon?cb.playerId:player.id;
    const np = {...gs.players};
    np[loserId]={...np[loserId],diceCount:Math.max(0,np[loserId].diceCount-1)};
    db.ref(`rooms/${roomId}`).update({phase:'REVEALED',players:np,
      lastAction:{type:'DUDO',caller:player.id,bidder:cb.playerId,success:callerWon,loserId,actualCount:count,bidWas:cb}});
    callerWon?SFX.win():SFX.lose();
  };

  const doShare = () => {
    const url=`${window.location.origin}${window.location.pathname}?room=${roomId}`;
    navigator.clipboard.writeText(url).catch(()=>{});
    setCopied(true); setTimeout(()=>setCopied(false),2200); SFX.click();
  };

  // â”€â”€ derived â”€â”€
  const me = gs?.players?.[player.id];
  const eliminated = me && (me.diceCount||0)===0;
  // only alive players take turns
  const turnSeq = gs?.playerSequence?.filter(pid=>(gs.players[pid]?.diceCount||0)>0)||[];
  const activeId = turnSeq[gs?.turnIndex % Math.max(1,turnSeq.length)];
  const isMyTurn = gs?.phase==='PLAYING' && !eliminated && activeId===player.id;
  const totalDice = gs ? Object.values(gs.players).reduce((s,p)=>(p.diceCount||0)+s,0) : 0;

  const getRS = pid => {
    if (!gs?.lastAction||gs.phase!=='REVEALED') return null;
    const la=gs.lastAction;
    if (pid===la.loserId) return 'lost';
    if (pid===la.caller&&la.success) return 'won';
    return null;
  };

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // LOBBY SCREEN
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  if (!gs) return React.createElement('div', {
    style:{width:'100%',height:'100%',height:'100dvh',display:'flex',flexDirection:'column',
      alignItems:'center',justifyContent:'center',gap:18,padding:'20px 22px',position:'relative',zIndex:1}
  },
    React.createElement('div',{style:{fontSize:'5rem',lineHeight:1,animation:'bounce-avatar 2.5s ease infinite',
      filter:'drop-shadow(0 4px 12px rgba(0,0,0,.5))'}}, 'ðŸŽ²'),

    // Create buttons: private / public
    React.createElement('div',{style:{display:'flex',gap:10,width:'100%',maxWidth:300}},
      React.createElement('button',{className:'btn btn-gold',
        style:{flex:1,padding:'14px 0',fontSize:'1.2rem'},
        onClick:()=>doCreate(false)},'ðŸ”’'),
      React.createElement('button',{className:'btn btn-ghost',
        style:{flex:1,padding:'14px 0',fontSize:'1.2rem',borderRadius:14},
        onClick:()=>doCreate(true)},'ðŸŒ')
    ),

    // Join by code
    React.createElement('div',{style:{display:'flex',gap:8,width:'100%',maxWidth:300}},
      React.createElement('input',{className:'casino-input',value:roomInput,
        onChange:e=>setRoomInput(e.target.value.substring(0,4).toUpperCase()),
        onKeyDown:e=>{if(e.key==='Enter')doJoin();},
        placeholder:'####',style:{flex:1,padding:'13px 10px',fontSize:'1.3rem',letterSpacing:8}}),
      React.createElement('button',{className:'btn btn-ghost',
        style:{padding:'13px 18px',fontSize:'1.2rem',borderRadius:12},
        onClick:()=>doJoin()},'â–¶')
    ),

    // Public rooms
    React.createElement(PublicRoomsList,{myId:player.id,onJoin:doJoin}),

    notif && React.createElement('div',{style:{position:'fixed',top:'38%',left:'50%',transform:'translate(-50%,-50%)',
      background:'rgba(232,64,64,.9)',borderRadius:20,padding:'10px 24px',fontSize:'1.5rem',zIndex:999,animation:'pop-in .2s ease'}},notif)
  );

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // GAME SCREEN
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  const allPlayers = gs.playerSequence.map(pid=>gs.players[pid]).filter(Boolean);

  return React.createElement('div', {
    style:{width:'100%',height:'100%',height:'100dvh',display:'flex',flexDirection:'column',overflow:'hidden',position:'relative',zIndex:1}
  },

    // Cup shake animation overlay
    cupShaking && React.createElement(CupShakeAnim, { onDone:()=>setCupShaking(false) }),

    // Result overlay
    showResult && gs.phase==='REVEALED' && gs.lastAction &&
      React.createElement(ResultScreen,{gs,myId:player.id,onNext:doNextRound}),

    // Win screen
    gs.phase==='WON' && gs.winnerId && React.createElement('div',{
      style:{position:'fixed',inset:0,zIndex:200,background:'radial-gradient(ellipse,#0f3d1a 0%,#050d08 100%)',
        display:'flex',flexDirection:'column',alignItems:'center',justifyContent:'center',gap:14,textAlign:'center',padding:20}},
      React.createElement('div',{style:{fontSize:'5rem',animation:'bounce-avatar 1s infinite'}},'ðŸ†'),
      React.createElement('div',{style:{fontSize:'3.5rem'}},gs.players[gs.winnerId]?.avatar),
      React.createElement('div',{style:{fontSize:'1.8rem',color:'#f5c842',textShadow:'0 0 12px rgba(245,200,66,.7)',letterSpacing:2}},gs.players[gs.winnerId]?.name),
      // Any player can restart
      React.createElement('button',{className:'btn btn-gold',
        style:{marginTop:10,padding:'14px 40px',fontSize:'1.15rem'},
        onClick:doRestart},'ðŸ”„')
    ),

    // Header
    React.createElement('div',{style:{display:'flex',justifyContent:'space-between',alignItems:'center',
      padding:'7px 12px',flexShrink:0,background:'rgba(0,0,0,.32)',borderBottom:'1px solid rgba(255,255,255,.08)'}},
      React.createElement('div',{style:{display:'flex',alignItems:'center',gap:8}},
        React.createElement('span',{style:{fontFamily:'monospace',fontSize:'1.25rem',color:'#f5c842',letterSpacing:4}},roomId),
        React.createElement('button',{className:'btn btn-ghost',
          style:{padding:'4px 9px',fontSize:'.78rem',borderRadius:9,border:'1px solid rgba(255,255,255,.15)'},
          onClick:doShare},copied?'âœ…':'ðŸ”—')
      ),
      // my card
      me && React.createElement(PlayerCard,{
        p:{...me,name:player.name,avatar:player.avatar},
        isActive:false, rState:null, isMe:true,
        onAvatar:nextAvatar, onName:n=>setPlayer(p=>({...p,name:n})),
        eliminated:false
      })
    ),

    // Table
    React.createElement('div',{style:{flex:1,display:'flex',flexDirection:'column',
      alignItems:'center',justifyContent:'space-between',padding:'8px 10px 8px',overflow:'hidden',gap:8,position:'relative'}},

      // Players row
      React.createElement('div',{style:{display:'flex',justifyContent:'center',flexWrap:'wrap',gap:8,width:'100%'}},
        allPlayers.map(p=>React.createElement(PlayerCard,{
          key:p.id, p,
          isActive:activeId===p.id&&gs.phase==='PLAYING',
          rState:getRS(p.id),
          isMe:p.id===player.id,
          onAvatar:p.id===player.id?nextAvatar:undefined,
          onName:p.id===player.id?n=>setPlayer(pp=>({...pp,name:n})):undefined,
          eliminated:(p.diceCount||0)===0
        }))
      ),

      // Center: bid display
      React.createElement('div',{style:{flex:1,display:'flex',alignItems:'center',justifyContent:'center',width:'100%'}},
        gs.phase==='PLAYING'
          ? React.createElement(BidCenter,{bid:gs.currentBid,players:gs.players})
          : gs.phase==='LOBBY'
            ? React.createElement('div',{style:{display:'flex',flexDirection:'column',alignItems:'center',gap:12}},
                React.createElement('div',{style:{fontSize:'2rem',opacity:.45,animation:'spin 6s linear infinite'}},'âš™ï¸'),
                React.createElement('div',{style:{fontSize:'.95rem',color:'rgba(255,255,255,.4)',letterSpacing:2}},gs.playerSequence.length+' ðŸŽ®'),
                React.createElement('button',{className:'btn btn-gold',
                  style:{padding:'13px 38px',fontSize:'1.2rem',marginTop:6},
                  onClick:doStartGame},'â–¶')
              )
            : null
      ),

      // Pyramid pile â€” absolute, bottom-right
      gs.tableDice > 0 && React.createElement(PyramidPile,{count:gs.tableDice,freshIdx:pileFlash})
    ),

    // Controls
    isMyTurn && gs.phase==='PLAYING' && React.createElement('div',{className:'ctrl'},
      // My dice
      me?.dice?.length>0 && React.createElement('div',{style:{display:'flex',justifyContent:'center',gap:6,marginBottom:10}},
        me.dice.map((d,i)=>React.createElement(DiceSVG,{key:i,val:d,size:40}))),

      // Bid controls
      React.createElement('div',{style:{display:'flex',alignItems:'center',justifyContent:'center',gap:10,marginBottom:10}},
        // Quantity
        React.createElement('div',{style:{display:'flex',alignItems:'center',gap:5,background:'rgba(255,255,255,.07)',borderRadius:14,padding:'5px 9px'}},
          React.createElement('button',{className:'btn btn-ghost',style:{width:33,height:33,padding:0,fontSize:'1.3rem',borderRadius:'50%',border:'none'},
            onClick:()=>setBid(b=>({...b,qty:Math.max(1,b.qty-1)}))}, 'âˆ’'),
          React.createElement('span',{style:{fontSize:'2rem',fontWeight:'bold',minWidth:34,textAlign:'center',color:'white'}},bid.qty),
          React.createElement('button',{className:'btn btn-ghost',style:{width:33,height:33,padding:0,fontSize:'1.3rem',borderRadius:'50%',border:'none'},
            onClick:()=>setBid(b=>({...b,qty:Math.min(totalDice,b.qty+1)}))}, '+')
        ),
        React.createElement('span',{style:{opacity:.3,fontSize:'1.2rem'}},'Ã—'),
        // Die value
        React.createElement('div',{style:{display:'flex',alignItems:'center',gap:5,background:'rgba(255,255,255,.07)',borderRadius:14,padding:'5px 9px'}},
          React.createElement('button',{className:'btn btn-ghost',style:{width:33,height:33,padding:0,fontSize:'1.3rem',borderRadius:'50%',border:'none'},
            onClick:()=>setBid(b=>({...b,val:b.val===1?6:b.val-1}))}, 'â€¹'),
          React.createElement(DiceSVG,{val:bid.val,size:42}),
          React.createElement('button',{className:'btn btn-ghost',style:{width:33,height:33,padding:0,fontSize:'1.3rem',borderRadius:'50%',border:'none'},
            onClick:()=>setBid(b=>({...b,val:b.val===6?1:b.val+1}))}, 'â€º')
        )
      ),

      // Action buttons
      React.createElement('div',{style:{display:'flex',gap:8}},
        gs.currentBid && React.createElement('button',{className:'btn btn-red',
          style:{flex:1,padding:'13px 0',fontSize:'1.4rem'},onClick:doCallDudo},'ðŸš¨'),
        React.createElement('button',{className:'btn btn-gold',
          style:{flex:2,padding:'13px 0',fontSize:'1.4rem'},onClick:doPlaceBid},'ðŸŽ¯')
      )
    ),

    // Spectator: show my dice if eliminated (greyed)
    !isMyTurn && eliminated && me?.dice?.length>0 && gs.phase==='PLAYING' &&
      React.createElement('div',{style:{padding:'8px 14px 10px',display:'flex',justifyContent:'center',gap:6,
        background:'rgba(0,0,0,.2)',borderTop:'1px solid rgba(255,255,255,.05)',flexShrink:0,opacity:.5}},
        me.dice.map((d,i)=>React.createElement(DiceSVG,{key:i,val:d,size:36}))),

    // Not my turn but still in game
    !isMyTurn && !eliminated && me?.dice?.length>0 && gs.phase==='PLAYING' &&
      React.createElement('div',{style:{padding:'8px 14px 10px',display:'flex',justifyContent:'center',gap:6,
        background:'rgba(0,0,0,.22)',borderTop:'1px solid rgba(255,255,255,.06)',flexShrink:0}},
        me.dice.map((d,i)=>React.createElement(DiceSVG,{key:i,val:d,size:38}))),

    // Toast
    notif && React.createElement('div',{style:{position:'fixed',top:'45%',left:'50%',transform:'translate(-50%,-50%)',
      background:'rgba(232,64,64,.9)',borderRadius:16,padding:'10px 24px',fontSize:'1.5rem',zIndex:999,
      pointerEvents:'none',animation:'pop-in .2s ease'}},notif)
  );
};

ReactDOM.render(React.createElement(App), document.getElementById('root'));
</script>
</body>
</html>
