<!DOCTYPE html>
<html lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LADODO - CASINO FIX</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Arimo:wght@700&display=swap');
        body { 
            background: radial-gradient(circle at center, #065f46 0%, #022c22 100%);
            color: white; font-family: 'Arimo', sans-serif;
            overflow: hidden; touch-action: manipulation; margin: 0;
        }
        .casino-felt {
            background-image: radial-gradient(circle, rgba(255,255,255,0.03) 1px, transparent 1px);
            background-size: 40px 40px;
        }
        @keyframes shake {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(5deg) translate(2px, 2px); }
            75% { transform: rotate(-5deg) translate(-2px, -2px); }
        }
        .shake-cup { animation: shake 0.15s infinite; }
        .gold-glow { box-shadow: 0 0 20px #eab308; border: 2px solid #eab308; }
        .win-highlight { transform: scale(1.3); filter: drop-shadow(0 0 10px #22c55e); border: 2px solid #22c55e; border-radius: 8px; }
        .btn-casino { 
            box-shadow: 0 6px 0 #b45309; transition: all 0.1s; 
        }
        .btn-casino:active { transform: translateY(4px); box-shadow: 0 2px 0 #b45309; }
    </style>
</head>
<body class="casino-felt">
    <div id="root"></div>

    <script>
        // --- AUDIO ---
        let audioCtx = null;
        const playSound = (f, t='sine', d=0.2) => {
            try {
                if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                if (audioCtx.state === 'suspended') audioCtx.resume();
                const o = audioCtx.createOscillator();
                const g = audioCtx.createGain();
                o.type = t; o.frequency.setValueAtTime(f, audioCtx.currentTime);
                g.gain.setValueAtTime(0.1, audioCtx.currentTime);
                g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + d);
                o.connect(g); g.connect(audioCtx.destination);
                o.start(); o.stop(audioCtx.currentTime + d);
            } catch(e) {}
        };

        // --- FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyCUvDUDrj1MofAFRYeDrGP7OoIz0qX0iW8",
            authDomain: "dudogame-44b81.firebaseapp.com",
            databaseURL: "https://dudogame-44b81-default-rtdb.europe-west1.firebasedatabase.app/",
            projectId: "dudogame-44b81",
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        const { useState, useEffect, useMemo } = React;
        const e = React.createElement;
        const AVATARS = ['ðŸŽ©', 'ðŸ’Ž', 'ðŸ’°', 'ðŸŽ°', 'ðŸ¦', 'ðŸ‘‘', 'ðŸƒ', 'ðŸ·', 'ðŸ’µ', 'ðŸŽ²'];

        const DiceIcon = ({ value, size = 40, highlight = false, className = "" }) => {
            const dots = {
                1: [[50, 50]], 2: [[25, 25], [75, 75]], 3: [[25, 25], [50, 50], [75, 75]],
                4: [[25, 25], [25, 75], [75, 25], [75, 75]], 5: [[25, 25], [25, 75], [50, 50], [75, 25], [75, 75]],
                6: [[25, 25], [25, 50], [25, 75], [75, 25], [75, 50], [75, 75]]
            };
            return e('svg', { width: size, height: size, viewBox: '0 0 100 100', className: `${highlight ? 'win-highlight' : ''} ${className}` },
                e('rect', { x: 5, y: 5, width: 90, height: 90, rx: 15, fill: value === 1 ? '#ef4444' : 'white' }),
                dots[value]?.map(([cx, cy], i) => e('circle', { key: i, cx, cy, r: 8, fill: value === 1 ? 'white' : 'black' }))
            );
        };

        const App = () => {
            const [player, setPlayer] = useState(() => {
                const saved = JSON.parse(localStorage.getItem('ladodo_v5') || '{}');
                return {
                    id: saved.id || Math.random().toString(36).substring(2, 9),
                    name: saved.name || '×©×—×§×Ÿ',
                    avatar: saved.avatar || AVATARS[Math.floor(Math.random()*AVATARS.length)]
                };
            });
            const [gameState, setGameState] = useState(null);
            const [roomId, setRoomId] = useState('');
            const [localBid, setLocalBid] = useState({ quantity: 1, value: 2 });
            const [isEditMode, setIsEditMode] = useState(false);
            const [shaking, setShaking] = useState(false);

            useEffect(() => localStorage.setItem('ladodo_v5', JSON.stringify(player)), [player]);

            // ×›× ×™×¡×” ××•×˜×•×ž×˜×™×ª ×ž×§×™×©×•×¨
            useEffect(() => {
                const code = new URLSearchParams(window.location.search).get('room');
                if (code) { setRoomId(code); syncRoom(code); }
            }, []);

            const syncRoom = (code) => {
                const ref = db.ref(`rooms/${code}`);
                ref.on('value', (snap) => {
                    const val = snap.val();
                    if (val) {
                        if (val.phase === 'REVEALED' && gameState?.phase !== 'REVEALED') {
                            if (val.lastAction?.success) confetti({ particleCount: 100, colors: ['#fbbf24'] });
                        }
                        setGameState(val);
                        if (val.currentBid) setLocalBid(val.currentBid);
                    }
                });
                // ×”×¦×˜×¨×¤×•×ª ××§×˜×™×‘×™×ª
                ref.transaction((room) => {
                    if (room) {
                        if (!room.players) room.players = {};
                        if (!room.playerSequence) room.playerSequence = [];
                        if (!room.players[player.id]) {
                            const counts = Object.values(room.players).map(p => p.diceCount).filter(c => c > 0);
                            const minDice = counts.length > 0 ? Math.min(...counts) : 5;
                            room.players[player.id] = { ...player, diceCount: minDice, dice: [] };
                            room.playerSequence.push(player.id);
                        } else {
                            // ×¢×“×›×•×Ÿ ×¤×¨×˜×™ ×©×—×§×Ÿ ×× ×”×©×ª× ×•
                            room.players[player.id].name = player.name;
                            room.players[player.id].avatar = player.avatar;
                        }
                        return room;
                    }
                });
            };

            const createRoom = () => {
                const code = Math.floor(1000 + Math.random() * 9000).toString();
                const initial = {
                    roomId: code, hostId: player.id, phase: 'LOBBY', turnIndex: 0,
                    playerSequence: [player.id], players: { [player.id]: { ...player, diceCount: 5, dice: [] } }
                };
                db.ref(`rooms/${code}`).set(initial).then(() => {
                    setRoomId(code);
                    syncRoom(code);
                });
            };

            const startRound = () => {
                setShaking(true);
                playSound(200, 'square');
                setTimeout(() => {
                    const updates = {};
                    gameState.playerSequence.forEach(pid => {
                        const p = gameState.players[pid];
                        if (p.diceCount > 0) {
                            updates[`players/${pid}/dice`] = Array.from({ length: p.diceCount }, () => Math.floor(Math.random() * 6) + 1);
                        }
                    });
                    updates['phase'] = 'PLAYING';
                    updates['currentBid'] = null;
                    updates['lastAction'] = null;
                    db.ref(`rooms/${roomId}`).update(updates);
                    setShaking(false);
                }, 1000);
            };

            const placeBid = () => {
                playSound(600);
                const nextTurn = (gameState.turnIndex + 1) % gameState.playerSequence.length;
                db.ref(`rooms/${roomId}`).update({
                    currentBid: { ...localBid, playerId: player.id },
                    turnIndex: nextTurn
                });
            };

            const callDudo = () => {
                const bid = gameState.currentBid;
                const allDice = Object.values(gameState.players).flatMap(p => p.dice || []);
                const count = allDice.filter(d => d === bid.value || (bid.value !== 1 && d === 1)).length;
                const success = count < bid.quantity;
                const loserId = success ? bid.playerId : player.id;
                
                const newPlayers = { ...gameState.players };
                newPlayers[loserId].diceCount = Math.max(0, newPlayers[loserId].diceCount - 1);

                db.ref(`rooms/${roomId}`).update({
                    phase: 'REVEALED', players: newPlayers,
                    lastAction: { success, loserId, actualCount: count, bidWas: bid }
                });
            };

            if (!gameState) return e('div', { className: 'h-screen flex flex-col items-center justify-center space-y-8 bg-[#022c22]' },
                e('div', { className: 'text-9xl animate-bounce' }, 'ðŸŽ°'),
                e('button', { onClick: createRoom, className: 'w-64 bg-yellow-500 text-black font-black py-6 rounded-2xl text-3xl btn-casino' }, '×—×“×¨ ×—×“×©'),
                e('div', { className: 'flex bg-white/10 p-2 rounded-2xl border border-white/20' },
                    e('input', { className: 'bg-transparent w-24 p-3 text-center text-2xl font-bold outline-none', placeholder: '×§×•×“', value: roomId, onChange: e => setRoomId(e.target.value) }),
                    e('button', { onClick: () => syncRoom(roomId), className: 'bg-green-600 px-6 rounded-xl font-bold' }, '×›× ×¡')
                )
            );

            const me = gameState.players[player.id] || {};
            const isMyTurn = gameState.phase === 'PLAYING' && gameState.playerSequence[gameState.turnIndex] === player.id;
            const deadDice = (gameState.playerSequence.length * 5) - Object.values(gameState.players).reduce((a, b) => a + b.diceCount, 0);

            return e('div', { className: 'h-screen flex flex-col' },
                // Header
                e('div', { className: 'p-4 flex justify-between items-center bg-black/40' },
                    e('button', { onClick: () => setIsEditMode(true), className: 'text-3xl bg-white w-12 h-12 rounded-full border-2 border-yellow-500 flex items-center justify-center' }, player.avatar),
                    e('div', { className: 'flex gap-2' },
                        e('span', { className: 'text-yellow-500 font-bold' }, `#${roomId}`),
                        e('button', { onClick: () => { navigator.clipboard.writeText(window.location.href); alert('COPIED!'); }, className: 'bg-blue-600 px-2 rounded' }, 'ðŸ”—')
                    )
                ),

                // Players List
                e('div', { className: 'flex justify-center flex-wrap gap-4 p-4' },
                    gameState.playerSequence.map(pid => {
                        const p = gameState.players[pid];
                        const active = gameState.phase === 'PLAYING' && gameState.playerSequence[gameState.turnIndex] === pid;
                        return e('div', { key: pid, className: `flex flex-col items-center p-2 rounded-xl transition-all ${active ? 'gold-glow bg-white/10' : 'opacity-40'}` },
                            e('div', { className: 'text-3xl' }, p.avatar),
                            e('div', { className: 'flex gap-1 mt-1' }, Array.from({ length: p.diceCount }).map((_, i) => e('div', { key: i, className: 'w-2 h-2 bg-yellow-400 rounded-full' })))
                        );
                    })
                ),

                // Table
                e('div', { className: 'flex-1 relative flex flex-col items-center justify-center' },
                    // Graveyard
                    e('div', { className: 'absolute top-0 flex flex-wrap max-w-[150px] gap-1 opacity-20' },
                        Array.from({ length: deadDice }).map((_, i) => e('div', { key: i, className: 'w-4 h-4 bg-white rounded rotate-12' }))
                    ),

                    shaking ? e('div', { className: 'text-9xl shake-cup' }, 'ðŸ¥¤') :
                    gameState.phase === 'LOBBY' ? e('button', { onClick: startRound, className: 'bg-green-500 w-24 h-24 rounded-full text-4xl shadow-2xl animate-pulse' }, 'â–¶ï¸') :
                    gameState.phase === 'REVEALED' ? e('div', { className: 'text-center bg-black/40 p-6 rounded-3xl border-2 border-white/10' },
                        e('div', { className: 'flex flex-wrap justify-center gap-2 mb-6' },
                            Object.values(gameState.players).flatMap(p => p.dice || []).map((d, i) => 
                                e(DiceIcon, { key: i, value: d, size: 35, highlight: d === gameState.lastAction.bidWas.value || d === 1 })
                            )
                        ),
                        e('button', { onClick: startRound, className: 'bg-white text-black px-10 py-3 rounded-full font-black' }, '×¡×™×‘×•×‘ ×—×“×© ðŸ”„')
                    ) :
                    gameState.currentBid && e('div', { className: 'flex items-center gap-4 scale-125' },
                        e('span', { className: 'text-6xl font-black' }, gameState.currentBid.quantity),
                        e('span', { className: 'text-2xl opacity-50' }, 'âœ•'),
                        e(DiceIcon, { value: gameState.currentBid.value, size: 70 })
                    )
                ),

                // Bottom Controls
                e('div', { className: 'p-6 bg-black/50 rounded-t-[2.5rem] border-t border-white/10' },
                    e('div', { className: 'flex justify-center gap-3 mb-6' },
                        me.dice?.map((d, i) => e(DiceIcon, { key: i, value: d, size: 50 }))
                    ),

                    isMyTurn && e('div', { className: 'space-y-4' },
                        e('div', { className: 'flex justify-around bg-black/40 p-2 rounded-2xl' },
                            e('div', { className: 'flex items-center gap-4' },
                                e('button', { onClick: () => setLocalBid(b => ({...b, quantity: Math.max(1, b.quantity-1)})), className: 'text-3xl' }, 'âž–'),
                                e('span', { className: 'text-3xl font-bold w-8 text-center' }, localBid.quantity),
                                e('button', { onClick: () => setLocalBid(b => ({...b, quantity: b.quantity+1})), className: 'text-3xl' }, 'âž•')
                            ),
                            e('div', { className: 'w-px bg-white/10 mx-2' }),
                            e('div', { className: 'flex items-center gap-4' },
                                e('button', { onClick: () => setLocalBid(b => ({...b, value: b.value === 1 ? 6 : b.value-1})), className: 'text-2xl' }, 'â—€ï¸'),
                                e(DiceIcon, { value: localBid.value, size: 45 }),
                                e('button', { onClick: () => setLocalBid(b => ({...b, value: b.value === 6 ? 1 : b.value+1})), className: 'text-2xl' }, 'â–¶ï¸')
                            )
                        ),
                        e('div', { className: 'flex gap-3' },
                            gameState.currentBid && e('button', { onClick: callDudo, className: 'flex-1 bg-red-600 py-4 rounded-xl text-3xl btn-casino border-b-4 border-red-800' }, 'ðŸ¤¥'),
                            e('button', { onClick: placeBid, className: 'flex-[2] bg-green-500 py-4 rounded-xl text-3xl btn-casino border-b-4 border-green-800' }, 'ðŸŽ²')
                        )
                    )
                ),

                // Edit Profile
                isEditMode && e('div', { className: 'fixed inset-0 bg-black/95 z-50 flex flex-col items-center justify-center p-6' },
                    e('div', { className: 'text-8xl mb-6' }, player.avatar),
                    e('input', { className: 'bg-white/10 p-4 rounded-xl text-2xl text-center border-2 border-yellow-500 mb-8', value: player.name, onChange: x => setPlayer({...player, name: x.target.value.slice(0,8)}) }),
                    e('div', { className: 'grid grid-cols-5 gap-4 mb-10' }, AVATARS.map(a => e('button', { key: a, onClick: () => setPlayer({...player, avatar: a}), className: 'text-4xl' }, a))),
                    e('button', { onClick: () => { setIsEditMode(false); syncRoom(roomId); }, className: 'bg-green-600 px-10 py-3 rounded-full text-xl font-bold' }, '×©×ž×•×¨ âœ…')
                )
            );
        };

        ReactDOM.render(e(App), document.getElementById('root'));
    </script>
</body>
</html>
